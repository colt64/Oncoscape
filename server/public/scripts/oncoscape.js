JAVASCRIPT_EVAL=eval,JAVASCRIPT_INDEX=0;var HubModule=function(){function e(e,t){Q[e]=t}function t(){return Q}function n(e,t){"string"==typeof e&&(e=[e]);for(var n=0;n<e.length;n++)U[e[n]]=t}function a(){return U}function o(e){console.log("=== Module.hub setupSocket");try{e.onopen=function(){console.log("websocket connection now open"),Z=!0;for(var e=0;e<X.length;e++)console.log("calling the next sockectConnectedFunction"),X[e]()},e.onmessage=function(e){if(""!=e.data){var e=JSON.parse(e.data);y(e)}}}catch(t){console.log("Error: "+t)}return e}function r(){return Z}function s(e){X.push(e)}function l(){return X}function c(e){Y.push(e)}function d(){return Y}function u(){setInterval(keepAlive,1e4);var e=d();console.log("==== Module.hub: "+e.length+" onDocumentReadyFunctions");for(var t=0;t<e.length;t++)console.log("calling on ready function"),e[t]()}function p(){return"undefined"==typeof window}function g(){p()&&(console.log("--- web socket not currently available when runing in Node"),process.exit(code=1)),J=new SockJS("http://localhost:80/oncoscape/",null,{sessionId:9}),J=o(J)}function h(){return J}function f(e,t){e in W?W[e].push(t):W[e]=[t]}function v(){return Object.keys(W)}function m(){return W}function y(e){var t=e.cmd;e.status;console.log("====== Module.hub dispatchMessage '"+t+"' ["+Date()+"]");var n=Object.keys(W),a=n.indexOf(t);if(console.log("hub.dispatchMessage("+t+"): "+a),-1===a)console.log("unrecognized socket request: "+e.cmd),console.log(" --- msg:"),console.log(e),console.log(" --- dispatchOptions"),console.log(W);else for(var o=W[t],r=0;r<o.length;r++)o[r](e)}function b(e){K=e}function _(e){var t=JSON.parse(e).cmd;if(K&&"checkPassword"===t)return void console.log("hub.send drops non-login msg");var n=Object.keys(W).indexOf(t)>=0,a="server";n&&(a="browser local"),console.log("--- hub.send: '"+t+"' ("+a+")"),n?y(JSON.parse(e)):J.send(e)}function w(e){window.document.title=e}function k(e,t,n,a){var o=$(e);o.append("<option>"+a+"</option>"),o.change(n);for(var r=Object.keys(hub.getRegisteredSelectionDestinations()),i=0;i<r.length;i++){var s=r[i],l=t.indexOf(s)>=0;l||o.append("<option>"+s+"</option>")}return o}function S(e,t,n,a,o){var r=void 0!=window.screenLeft?window.screenLeft:screen.left,i=void 0!=window.screenTop?window.screenTop:screen.top;width=window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width,height=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height;var s,l=width/2-n/2+r,c=height/2-a/2+i,d="scrollbars=yes, width="+n+", height="+a+", top="+c+", left="+l;return s=o?window.open(e,t,d):window.open(e,"_blank",d),window.focus&&s.focus(),s}function T(e){e.prop("disabled",!0),e.css({"background-color":"lightgray",color:"gray"})}function x(e){e.prop("disabled",!1),e.css({"background-color":"white",color:"black"})}function D(e){"string"==typeof e&&(e=[e]);var t=I();t=t.filter(function(t,n){return-1==e.indexOf(n)});for(var n=0;n<t.length;n++)M(t[n]);return t}function M(e){$("#oncoscapeTabs").tabs("disable","#"+e)}function C(e){$("#oncoscapeTabs").tabs("enable","#"+e)}function A(e){var t=$("#oncoscapeTabs");if(t.length>0){var n='#oncoscapeTabs a[href="#'+e+'"]',a=$(n).parent().index();if(0>a)throw"Module.hub does not recognize tabIDString '"+e+"'";console.log("Module.hub:raiseTab for '"+e+"' ("+a+") set to active'"),setTimeout(function(){t.tabs("option","active",a)},1)}}function O(){var e=$("#oncoscapeTabs").children()[0].textContent.trim().split("\n");for(i=0;i<e.length;i++)e[i]=e[i].trim();return e=e.filter(function(e){return""!=e})}function I(){return $("#oncoscapeTabs").children("div").map(function(e,t){return t.id})}function N(e,t){$(".ui-tabs-nav li:contains('"+e+"')").hide(),$(t).hide()}function E(e){$(".ui-tabs-nav li:contains('"+e+"')").hide()}function R(e,t){$(".ui-tabs-nav li:contains('"+e+"')").show(),$(t).show()}function P(e,t,n){var a=$("#oncoscapeTabs").tabs(),o="<li><a href='#"+t+"}'>"+e+"</a>";a.find(".ui-tabs-nav").append(o),a.append("<div id='"+t+"'><p>"+n+"</p></div>"),a.tabs("refresh")}function G(e,t){return Math.random()*(t-e)+e}function L(e,t){return Math.floor(Math.random()*(t-e+1))+e}function H(e,t){hits=[];for(var n=0;n<e.length;n++)for(var a=0;a<t.length;a++)candidate=e[n],target=t[a],index1=candidate.indexOf(target),index2=target.indexOf(candidate),0==index1?hits.push(target):0==index2&&hits.push(target);return hits}function B(){window.onerror=function(e,t,n,a,o){var r="Oncoscape Error",i={buttons:{Ok:function(){$(this).dialog("close")}},title:r},s="<i>"+e+"</i><br><br><b>Script</b>: "+t+"<br><b>Line:</b> "+n+"<br><b>Column:</b> "+a+"<br><b>StackTrace:</b> "+o;$("<div></div>").dialog(i).html(s)}}function z(){B(),g(),$(document).ready(u),QUnit.config.altertitle=!1}function F(e,t,n,a){console.log("about to logEvent: "+t),payload={eventName:t,eventStatus:n,moduleOfOrigin:e,comment:a},hub.send(JSON.stringify({cmd:"logEvent",callback:"",status:"request",payload:payload}))}function V(){console.log("---  test_intersectionOfArrays");var e=["TCGA.02.0006"],t=["TCGA.02.0006"];QUnit.test("test_intersectionOfArrays 1",function(n){n.equal(hub.intersectionOfArrays(t,e),t)}),e=["TCGA.02.0006"],t=["bogus"],QUnit.test("test_intersectionOfArrays 2",function(n){n.equal(hub.intersectionOfArrays(t,e),[])}),e=["bogus"],t=["TCGA.02.0006"],QUnit.test("test_intersectionOfArrays 3",function(n){n.equal(hub.intersectionOfArrays(t,e),[])}),e=["TCGA.02.0006.01"],t=["TCGA.02.0006"],QUnit.test("test_intersectionOfArrays 4",function(n){n.equal(hub.intersectionOfArrays(t,e),t)})}function q(){V()}var J,j="HubModule",U={},W={},Z=!1,X=[],Y=[],K=(window.location.href.replace("http://","ws://"),!1),Q={};return keepAlive=function(){msg={cmd:"keepAlive",callback:"",status:"request",payload:""},J.send(JSON.stringify(msg))},String.prototype.beginsWith=function(e){return 0===this.toLowerCase().indexOf(e.toLowerCase())},uniqueElementsOfArray=function(e){for(var t={},n=[],a=0,o=e.length;o>a;++a)t.hasOwnProperty(e[a])||(n.push(e[a]),t[e[a]]=1);return n},{getName:function(){return j},restrictMessagingToLogin:b,registerModule:e,getModules:t,registerSelectionDestination:n,getRegisteredSelectionDestinations:a,socketConnected:r,addSocketConnectedFunction:s,getSocketConnectedFunctions:l,addOnDocumentReadyFunction:c,getOnDocumentReadyFunctions:d,runningInNode:p,initializeWebSocket:g,getSocket:h,addMessageHandler:f,getRegisteredMessageNames:v,getDispatchOptions:m,dispatchMessage:y,configureSendSelectionMenu:k,openCenteredBrowserWindow:S,enableButton:x,disableButton:T,enableTab:C,disableTab:M,disableAllTabsExcept:D,getRandomInt:L,getRandomFloat:G,intersectionOfArrays:H,uniqueElementsOfArray:uniqueElementsOfArray,send:_,setTitle:w,getTabDivIDs:I,getTabNames:O,raiseTab:A,hideTab:N,hideTabNav:E,showTab:R,addTab:P,sat:q,start:z,logEventOnServer:F}},hub=HubModule();hub.start(),hub.addOnDocumentReadyFunction(function(){console.log("====== tabapps document ready"),window.tabsAppRunning=!0,$("#oncoscapeTabs").tabs({activate:function(e,t){console.log(" tabsApp/code.js:activate");var n=$("#historyTable").dataTable(),a=$("#userDataStoreTable").dataTable();n.length>0&&(console.log("   adjusting patient history table"),n.fnAdjustColumnSizing()),a.length>0&&(console.log("   skipping! - adjusting user data store table"),a.fnAdjustColumnSizing()),"undefined"!=typeof cwMarkers&&(console.log("adjusting cwMarkers? "+cwMarkers.width()+" * "+cwMarkers.height()),cwMarkers.width()>0&&(cwMarkers.resize(),console.log("after resize"),cwMarkers.fit(50),console.log("done adjusting cwMarkers"))),"undefined"!=typeof cyGbm&&(cyGbm.resize(),cyGbm.fit(50)),"undefined"!=typeof cwAngio&&(cwAngio.resize(),cwAngio.fit(50)),"undefined"!=typeof cyPathway&&(cyPathway.resize(),cyPathway.fit(50))}})}),$(document).ready(function(){hub.raiseTab("datasetsDiv"),hub.setTitle("oncoscape")});var DashboardModule=function(){function e(){console.log(navigator.userAgent),console.log("===== Display User Information"),$("#DashboardAccordion").accordion({active:!1,heightStyle:"content",collapsible:!0,icons:null}),$("#AvailableDataAccordian").accordion({active:!1,heightStyle:"content",collapsible:!0,icons:null}),t(),document.getElementsByName("newWindow").onclick=function(){return!window.open(this.href)}}function t(){var e=$("#TCGAdataInfo");e.append("<p><h4 align=center>Glioblastoma multiforme (GBM) Pilot demo</h4></p>"),e.append("<p>Copy Number Alterations, Single Nucleotide Alterations, indels and patient histories were downloaded from the "+n+", based off the 2013 publication "+a+" and supplemented by in-house data.</p>"),e.append("<div id='TCGArnadata'><p>The TCGA GBM expression data included in Oncoscape is for 304 patients that meet the following criteria:<br><ol type='A'><li>TCGA clinical data has (529 GBM samples) <ul> <li>'histologic type' is 'GBM'</li><li>'sample type' is 'primary'</li><li>an assigned expression subtype (ie not empty)</li></ul><li>TCGA expression data within unified (Agilent + Affymetrix) set defined in comparative paper (PMID:21436879)  (323 GBM samples).</li></ol></p></div>");var t=$("#UWMSCCAdataInfo");t.append("<p>Access to information regarding <a href='http://www.uwmedicine.org/' name='newWindow'>University of Washington Medicine</a> and <a href='http://www.seattlecca.org/'  name='newWindow'>SCCA</a> patients is restricted by IRB approval.  Please contact <a href='http://www.fhcrc.org/en/diseases/featured-researchers/fearn-paul.html'  name='newWindow'>Paul Fearn</a> for questions regarding access.</p>");var o=$("#TableContentsDiv");o.append("<p><h4>Patient History:</h4> Table view of patient information.  Filter data by Age of Diagnosis & survival sliders or by specific search terms.</p>"),o.append("<p><h4>Patient Timelines:</h4> Visual representation of patient histories.  Align or Order patient histories by clinical events.  Couple features (e.g. time to progression, histology type, or age at diagnosis) with patient timelines. </p>"),o.append("<p><h4>Principle Component Analysis (PCA):</h4> Two dimensional view of per sample expression data.</p>"),o.append("<p><h4>Partial Least Squares Regression (PLSR):</h4> Use linear regression to correlate genes with clinical features using RNA expression </p>"),o.append("<p><h4>GBM Pathways:</h4> Map patient specific expression levels on a hand curated network of genes associated with GBM.  Click on edges to view the abstracts defining the relationship. </p>"),o.append("<p><h4>Markers & Patients:</h4> Link copy number variation and mutation data to patients grouped by GBM classification: mesenchymal, classical, neural, proneural, and G-CIMP </p>"),o.append("<p><h4>Survival:</h4> Compare survival rates of selected patients against the remaining population in a Kaplan Meier plot.</p>");var r=$("#AboutOncoscapeDiv");r.append("<p>Oncoscape is developed at the <a href= 'http://www.fhcrc.org' name='newWindow'>Fred Hutchinson Cancer Research Center</a> under the auspices of the <a href='http://www.sttrcancer.org' name='newWindow'>Solid Tumor Translational Research</a> initiative.</p>"),r.append("<p> Oncoscape is a web-based, menu-driven analysis and visualization platform for large-scale, heterogeneous clinical and molecular patient timeline data as exemplified by the <a href='http://www.fhcrc.org/en/labs/hidra.html'  name='newWindow'>Fred Hutch HIDRA</a> database.</p>"),r.append("<p>Oncoscape was conceived, and is managed, by a Steering Committee comprising: <a href='http://www.fhcrc.org/en/diseases/featured-researchers/holland-eric.html' name='newWindow'>Eric Holland</a>, <a href='http://www.sttrcancer.org/en/contact-us.html'  name='newWindow'>Desert Horse-Grant</a>, <a href='http://www.fhcrc.org/en/diseases/featured-researchers/fearn-paul.html'  name='newWindow'>Paul Fearn</a>, <a href='http://fhcrc.academia.edu/PaulShannon'  name='newWindow'>Paul Shannon</a>,<a href='http://www.researchgate.net/profile/Lisa_McFerrin' name='newWindow'>Lisa McFerrin</a>, and <a href='http://research.fhcrc.org/bolouri/' name='newWindow'>Hamid Bolouri</a>.</p>"),r.append("<p> Paul Shannon (lead) and Lisa McFerrin are the primary developers of Oncoscape, with additional code contributions by Cliff Rostomily and Hamid Bolouri.</p>")}var n="<a href='https://tcga-data.nci.nih.gov/tcga/tcgaCancerDetails.jsp?diseaseType=GBM&diseaseid=Glioblastoma%20multiforme' name='newWindow'>TCGA portal</a>",a="<a href='http://www.ncbi.nlm.nih.gov/pubmed/24120142' name='newWindow'>(Brennan et al, Cell 2013)</a>";return{init:function(){hub.addOnDocumentReadyFunction(e)}}};Dashboard=DashboardModule(),Dashboard.init(),hub.registerModule("Dashboard",Dashboard);var DataSummaryModule=function(){function e(){w=hub.configureSendSelectionMenu("#datasetsSendSelectionsMenu",[k],a,T),hub.disableButton(w),$(window).resize(n),y=$("#datasetMenu"),y.change(o),f=$("#dataSetNamesOutputDiv"),g=$("#dataSummaryOutputDiv"),_=$("#selectDatasetButton"),_.button(),hub.disableButton(_),_.click(c),h=$("#dataSummaryOutputDiv"),v=$("#datasetsManifestTable");var e=1===$("#loginDiv").length;console.log("loginRequired? "+e),e?(console.log(" disabling datasetMenu"),hub.disableButton($("#datasetMenu"))):(console.log(" enabling datasetMenu"),hub.enableButton($("#datasetMenu"))),hub.socketConnected()?r():hub.addSocketConnectedFunction(r)}function t(e){$("#datasetsStatusDiv").text(e),$("#datasetsMinorStatusDiv").text(e)}function n(){$("#"+S).width(.95*$(window).width())}function a(e){var t=w.val();console.log("send selections to "+t),w.val(T);var n="sendSelectionTo_"+t;payload="dummy payload";var a={cmd:n,callback:"",status:"request",payload:payload};w.val(T),hub.send(JSON.stringify(a))}function o(e){b=y.val(),console.log("dataset '"+b+"'"),$("#datasetsManifestTable").css("display","none"),""===b?($("#datasetInstructions").css("display","block"),hub.disableButton(_)):($("#datasetInstructions").css("display","none"),s(b))}function r(){console.log("Module.datasets, entering populateDataSetMenu"),console.log("      socket connected? "+hub.socketConnected()),console.log("=== datasetMenu ready, now issuing populateDataSetMenu request to server");var e={cmd:"getDataSetNames",callback:"handleDataSetNames",status:"request",payload:""};hub.send(JSON.stringify(e))}function i(e){console.log("=== handleDataSetNames");var t=e.payload.datasets;console.log("dataSetNames length: "+t.length),console.log("dataSetNames: "+JSON.stringify(t));e.payload.passwordProtected;Array.isArray(t)||(t=[t]);for(var n=0;n<t.length;n++){var a=t[n];y.append("<option value='"+a+"'>"+a+"</option>")}$("#datasetsMinorStatusDiv").text("datasetMenu loaded")}function s(e){console.log("=== requestDataSetSummary");var t={cmd:"getDataManifest",callback:"displayDataManifest",status:"request",payload:e};hub.logEventOnServer(k,"datasets requestDataSummary","request",e),hub.send(JSON.stringify(t))}function l(e){$("#datasetsManifestTable").css("display","block");for(var a=e.payload,o=a.colnames,r=[],i=0;i<o.length;i++)r.push({sTitle:o[i]});"undefined"!=typeof m&&(m.destroy(),v.empty()),$(v).ready(function(){m=v.DataTable({aoColumns:r,bPaginate:!1,bFilter:!1,bAutoWidth:!0,bSort:!1,bInfo:!1}),m=$("#datasetsManifestTable").DataTable(),m.rows.add(a.mtx).draw(),$("#datasetsManifestTable tbody").on("click","tr",function(){console.log("=== click");var e=$("td",this).eq(0).text(),t=$("td",this).eq(1).text();$(this).hasClass("selected")?($(this).removeClass("selected"),hub.disableButton(w)):(m.$("tr.selected").removeClass("selected"),$(this).addClass("selected"),hub.enableButton(w),console.log("selected "+e+", "+t))}),n(),hub.enableButton(_),t("manifest table displayed"),hub.logEventOnServer(k,"datasets requestDataSummary","complete","")})}function c(){console.log("Module.datasets 'Use Dataset' button clicked, specifyCurrentDataset: "+b),hub.disableAllTabsExcept([S,"userDataStoreDiv","ericTestDiv","DashboardDiv"]),$("#loadingDatasetMessage").css("display","inline");var e={cmd:"specifyCurrentDataset",callback:"datasetSpecified",status:"request",payload:b};hub.send(JSON.stringify(e))}function d(e){$("#loadingDatasetMessage").css("display","none"),console.log("--- Module.datasets:  datasetSpecified")}function u(e){console.log("Module.datasets test, on datasetName: '"+e+"'"),QUnit.test("choose dataset '"+e+"'",function(t){hub.raiseTab("datasetsDiv");var n=e,a=$("#datasetMenu option").map(function(e){return this.value});if($.inArray(n,a)<0)return void alert("cannot run tests:  "+n+" dataset not loaded");$("#datasetMenu").val(n),$("#datasetMenu").trigger("change");var o=t.async(),r=t.async(),i=t.async();t.expect(3),setTimeout(function(){t.equal($("#datasetMenu").val(),n),o(),t.ok($("#datasetsManifestTable tr").length>=10),r(),t.equal($("#datasetsManifestTable tbody tr").eq(0).find("td").eq(0).text(),"mRNA expression"),i()},5e3)})}function p(){hub.addOnDocumentReadyFunction(e),hub.addMessageHandler("handleDataSetNames",i),hub.addMessageHandler("displayDataManifest",l),hub.addMessageHandler("datasetSpecified",d)}var g,h,f,v,m,y,b,_,w,k="Datasets",S="datasetsDiv",T="Send selection...";return{init:p,test:u}},dataSummaryModule=DataSummaryModule();dataSummaryModule.init(),hub.registerModule("Datasets",dataSummaryModule);var patientHistoryTableRef,ageAtDxMinReadout,ageAtDxMaxReadout,survivalMinReadout,survivalMaxReadout,ageAtDxMin,ageAtDxMax,ageAtDxSlider,survivalSlider,survivalMin,survivalMax,PatientHistoryModule=function(){function e(){console.log("=== Module.patientHistory, initializeUID"),$(window).resize(s),f=$("#patientHistoryStatusDiv"),v=$("#patientHistoryDiv"),m=$("#patientHistoryControlsDiv"),y=$("#patientHistoryTableDiv"),b=$("#patientHistoryTable"),w=$("#patientHistoryShowAllRowsButton"),w.click(i),_=hub.configureSendSelectionMenu("#patientHistorySendSelectionsMenu",T,l,x),s(),hub.disableTab(S)}function t(e,t){for(var s=[],l=0;l<e.length;l++)s.push({sTitle:e[l]});if("undefined"!=typeof patientHistoryTableRef&&(patientHistoryTableRef.destroy(),b.empty()),patientHistoryTableRef=b.DataTable({data:t,columns:s,dom:'C<"clear">lfrtip',paging:!1,jQueryUI:!1}),e.indexOf("AgeDx")>=0){var c=r(t,e.indexOf("AgeDx"));console.log("minMax for AgeDx: "),console.log(c),ageAtDxMin=c[0],ageAtDxMax=c[1],a(ageAtDxMin,ageAtDxMax)}e.indexOf("Survival")>=0&&(c=r(t,e.indexOf("Survival")),console.log("minMax for Survival: "),console.log(c),survivalMin=c[0],survivalMax=c[1],o(survivalMin,survivalMax)),i(),n(e)}function n(e){var t=e.indexOf("AgeDx"),n=e.indexOf("Survival");t>=0&&jQuery.fn.dataTable.ext.search.push(function(e,n,a){var o=parseFloat(ageAtDxMinReadout.val()),r=parseFloat(ageAtDxMaxReadout.val()),i=parseFloat(n[t])||0,s=i>=o&&r>=i;return s?!0:!1}),n>=0&&jQuery.fn.dataTable.ext.search.push(function(e,t,a){var o=parseFloat(survivalMinReadout.val()),r=parseFloat(survivalMaxReadout.val()),i=parseFloat(t[n])||0,s=i>=o&&r>=i;return s?!0:!1})}function a(e,t){ageAtDxSlider=$("#ageAtDxSlider"),ageAtDxMinReadout=$("#ageAtDxMinSliderReadout"),ageAtDxMaxReadout=$("#ageAtDxMaxSliderReadout"),ageAtDxSlider.slider({range:!0,slide:function(e,t){return t.values[0]>t.values[1]?!1:(ageAtDxMinReadout.text(t.values[0]),ageAtDxMaxReadout.text(t.values[1]),patientHistoryTableRef.draw(),void s())},min:e,max:t,values:[e,t]}),ageAtDxMinReadout.text(e),ageAtDxMaxReadout.text(t)}function o(e,t){survivalSlider=$("#survivalSlider"),survivalMinReadout=$("#survivalMinSliderReadout"),survivalMaxReadout=$("#survivalMaxSliderReadout"),console.log("createSurvivalWidget"),survivalSlider.slider({range:!0,slide:function(e,t){return t.values[0]>t.values[1]?!1:(survivalMinReadout.text(t.values[0]),survivalMaxReadout.text(t.values[1]),patientHistoryTableRef.draw(),void s())},min:e,max:t,values:[e,t]}),survivalMinReadout.text(e),survivalMaxReadout.text(t)}function r(e,t){for(var n=e.length,a=Number.MAX_VALUE,o=-Number.MAX_VALUE,r=0;n>r;r++){var i=parseFloat(e[r][t]);a>i&&(a=i),i>o&&(o=i)}return[Math.floor(a),Math.ceil(o)]}function i(){"undefined"!=typeof ageAtDxMin&&"undefined"!=typeof ageAtDxMax&&"undefined"!=typeof survivalMin&&"undefined"!=typeof survivalMax&&(ageAtDxSlider.slider("values",[ageAtDxMin,ageAtDxMax]),survivalSlider.slider("values",[survivalMin,survivalMax]),ageAtDxMinReadout.text(ageAtDxMin),ageAtDxMaxReadout.text(ageAtDxMax),survivalMinReadout.text(survivalMin),survivalMaxReadout.text(survivalMax)),"undefined"!=typeof patientHistoryTableRef&&patientHistoryTableRef.search("").columns().search("").draw(),s()}function s(){v.width(.95*$(window).width()),v.height(.9*$(window).height()),m.width(v.width()),m.height("100px"),y.width(v.width()),y.height(v.height()-130)}function l(e){var t=_.val(),n=patientHistoryTableRef.rows({filter:"applied"})[0];if(0!==n.length){for(var a=[],o=patientHistoryTableRef.data(),r=0;r<n.length;r++){var i=o[n[r]][0];a.push(i)}var s="sendSelectionTo_"+t;payload={value:a,count:a.length,source:"patient history module"};var l={cmd:s,callback:"",status:"request",payload:payload};_.val(x),hub.send(JSON.stringify(l))}}function c(e){i();var t=e.payload.value;"string"==typeof t&&(t=[t]),t=t.map(function(e){return e.replace(/\.0[0-9]$/,"")}),filterByString(t),hub.raiseTab(S)}function d(e){var n=e.payload,a=n.colnames,o=n.tbl;console.log("incoming table, rows: "+o.length),console.log("incoming table, cols: "+o[0].length),t(a,o),u("patientHistory data table loaded"),hub.enableTab(S)}function u(e){f.text(e)}function p(e){var t=e.payload,n={datasetName:t,durationFormat:"byYear"},a={cmd:"getPatientHistoryTable",callback:"displayPatientHistoryTable",status:"request",payload:n};hub.send(JSON.stringify(a))}function g(){var e={cmd:"specifyCurrentDataset",callback:"datasetSpecified",status:"request",payload:"TCGAgbm"};hub.send(JSON.stringify(e))}function h(){var e={cmd:"sendSelectionTo_patientHistory",status:"request",callback:"",payload:["TCGA.02.0011","TCGA.06.0238"]};hub.send(JSON.stringify(e))}var f,v,m,y,b,_,w,k="patientHistory",S="patientHistoryDiv",T=[k],x="Send selection...";return filterByString=function(e){for(var t=e[0],n=1;n<e.length;n++)t+="|"+e[n];i(),console.log(t),"undefined"!=typeof patientHistoryTableRef&&patientHistoryTableRef.search(t,!0,!1).draw()},{init:function(){hub.registerSelectionDestination(T,S),hub.addOnDocumentReadyFunction(e),hub.addMessageHandler("sendSelectionTo_patientHistory",c),hub.addMessageHandler("datasetSpecified",p),hub.addMessageHandler("displayPatientHistoryTable",d)},testSelect:h,testLoad:g}};pts=PatientHistoryModule(),pts.init();var TimeLineModule=function(){function e(){console.log("========== initializing Timeline UI"),d=new Date,I=d.getTime(),d=new Date,N=d.getTime(),console.log("Initialize UI start: ",N-I),I=N,G=$("#TimeLineDisplay"),t(),O=hub.configureSendSelectionMenu("#timeLineSendSelectionsMenu",j,s,J),$(window).resize(t),$("#AlignOptions").change(b),$("#OrderOptions").change(_),$("#SideBarOptions").change(w),$("#FitToPage").change(function(){t()}),B=d3.select("#TimeLineDisplay").append("svg").attr("id","timelineSVG").attr("width",TimeLineSize.width+2*L.width+2*X.left+2*X.right).attr("height",L.height+X.top+X.bottom+H.height),q=d3.select("body").attr("data-toggle","tooltip").attr("class","tooltip").append("div").attr("id","tooltipDiv").attr("class","tooltipNoHover").style("position","absolute").style("z-index","10").style("background","lightgray").style("border","thin solid black").style("border-radius","5px").style("padding","10px").style("overflow-y","auto"),q.on("mouseover",function(){this.className="tooltipHover"}),q.on("mouseout",function(){for(var e=document.getElementsByClassName("tooltipHover"),t=0;t<e.length;t++)e[t].className="tooltipNoHover"}),hub.disableTab(W)}function t(){var e,t;$("#FitToPage").is(":checked")?(G.width(.9*$(window).width()),G.height(.9*$(window).height()),e=$("#TimeLineDisplay").width(),t=$("#TimeLineDisplay").height(),TimeLineSize={width:.8*e-X.left-X.right,height:.9*t-X.top-X.bottom},L={width:.25*e-X.left-X.right,height:.9*t-X.top-X.bottom},H={width:TimeLineSize.width,height:.1*t}):(G.width(.9*$(window).width()),e=$("#TimeLineDisplay").width(),t=20*Z.length,TimeLineSize={width:.8*e-X.left-X.right,height:t},L={width:.25*e-X.left-X.right,height:t},H={width:TimeLineSize.width,height:H.height}),"undefined"!=typeof F&&n()}function n(){h(),m(),S(),T()}function a(e,t){t="undefined"!=typeof t?t:U;var n=0>e?-1:1;return n*Math.log(Math.abs(e/t)+1)/Math.log(2)}function o(e){var t=e.getDate(),n=e.getMonth()+1,a=e.getFullYear();return 10>t&&(t="0"+t),10>n&&(n="0"+n),e=n+"/"+t+"/"+a}function r(e,t){var n=P[e].orderVal;return t.splice(i(n,t)+1,0,e),t}function i(e,t,n,a){if(t.length>0&&P[t[0]].orderVal<e||"undefined"==typeof e)return-1;n=n||0,a=a||t.length;var o=parseInt(n+(a-n)/2,10);return 1>=a-n||P[t[o]].orderVal===e?o:P[t[o]].orderVal>e||"undefined"==typeof P[t[o]].orderVal?i(e,t,o,a):i(e,t,n,o)}function s(){var e=O.val(),t=l(),n="sendSelectionTo_"+e,a={value:t,count:t.length,source:"timelines module"},o={cmd:n,callback:"",status:"request",payload:a};O.val(J),hub.send(JSON.stringify(o))}function l(){currentlySelectedRegion=TimeLined3PlotBrush.extent();for(var e=currentlySelectedRegion[0][0],t=currentlySelectedRegion[0][1],n=currentlySelectedRegion[1][0],o=currentlySelectedRegion[1][1],r=[],i=Z.slice(Math.max(Math.floor(t)+1,0),Math.min(Math.ceil(o),Z.length-1)),s=document.getElementById("AlignOptions"),l=s.options[s.selectedIndex].text,c=0;c<i.length;c++)for(var d=P[i[c]],u=d.dateEvents,p=0;p<u.length;p++)if("--"==l){if(u[p].date-d.offset>=e&u[p].date-d.offset<=n){r.push(i[c]);break}}else if(a(u[p].date-d.offset)>=e&a(u[p].date-d.offset)<=n){r.push(i[c]);break}return r}function c(e){e.payload.datasetName;d=new Date,I=d.getTime(),d=new Date,N=d.getTime(),console.log("Dataset specified start: ",N-I),I=N;var t=e.payload.rownames,n=t.map(function(e){return e.indexOf("history")>=0?e:void 0});n=n.filter(function(e){return void 0!==e});var a=null;n.length>0&&(a=n[0].replace(".RData",""),u())}function u(){console.log("create Timelines on server "),payload="",msg={cmd:"createTimelines",callback:"DisplayPatientTimeLine",status:"request",payload:payload},msg.json=JSON.stringify(msg),hub.send(msg.json)}function p(e){if("success"==e.status){var t=e.payload;Z=t.filter(function(e){return-1!==Object.keys(P).indexOf(e)}),C(),n()}else console.log("Timelines handlePatientIDs about to call alert: "+e),alert(e.payload);hub.raiseTab(W)}function g(e){if("request"==e.status){var t=e.payload.value;e={cmd:"canonicalizePatientIDsInDataset",callback:"TimelinesHandlePatientIDs",status:"request",payload:t},hub.send(JSON.stringify(e))}else console.log("handlePatientIDs about to call alert: "+e),alert(e.payload)}function h(){console.log("======== initDisplay"),B.selectAll("g").remove(),$("#timelineSVG").attr("width",TimeLineSize.width+2*L.width+2*X.left+2*X.right).attr("height",L.height+X.top+X.bottom+H.height),z=B.append("g").attr("id","SidePlotSVG").attr("transform","translate("+X.left+","+X.top+")"),F=B.append("g").attr("id","TimeLineSVG").attr("transform","translate("+(L.width+X.left+X.right)+","+X.top+")")}function f(e){function t(e){e.date=new Date(e.date),e.ptID=o,"single"==e.eventOrder?R[e.eventID].Fields.date=e.date:"start"==e.eventOrder?R[e.eventID].Fields.date[0]=e.date:"end"==e.eventOrder&&(R[e.eventID].Fields.date[1]=e.date)}console.log("==== loadPatientDataDisplay"),d=new Date,N=d.getTime(),console.log("load data started: ",N-I),I=N,$('select[name="AlignOptions"] option[value="--"]').attr("selected","selected"),$('select[name="OrderOptions"] option[value="--"]').attr("selected","selected"),R=e.payload.events,P=e.payload.pts,E=e.payload.eventTypes,console.log("Event count: "+R.length),console.log("Patient count: "+P.length),console.log("Category count: "+E.length);var a=0;Z=[];for(var o in P)P[o].showPatient=!0,P[o].PatientHeight=1,P[o].offset=0,P[o].orderVal=a,Z.push(o),a++,P[o].dateEvents.forEach(t);for(var r in E)E[r].disabled=!1;d=new Date,N=d.getTime(),console.log("Load data finished: ",N-I),I=N,v(),n()}function v(){console.log("======== load.Menu");var e=[];for(var t in E)E[t].dateIndicator&&e.push(t);$(".plotCategoryOptions").empty(),$(".plotValueOptions").empty(),$("#AlignOptions").empty(),$("#AlignOptions").append("<option value='--' selected='selected'>--</option>"),$(".OrderByDateOptions").empty(),$(".OrderByValueOptions").empty();for(var n in e)$("#AlignOptions").append(" <option>"+e[n]+"</option>"),$(".OrderByDateOptions").append(" <option class='OrderByDate'>"+e[n]+"</option>"),$("#Event1").append("<option value='"+e[n]+"'>"+e[n]+"</option>"),$("#Event2").append("<option value='"+e[n]+"'>"+e[n]+"</option>");var a=P[Z[0]].calcEvents;for(var o in a)$(".OrderByValueOptions").append(" <option>"+a[o].name+"</option>"),$(".plotValueOptions").append(" <option>"+a[o].name+"</option>")}function m(){V=B.append("g").attr("class","legend").attr("transform","translate("+(L.width+2*X.left+X.right)+",0)").selectAll(".legend").data(te.domain().filter(function(e){return-1!==Object.keys(E).indexOf(e)})).enter().append("g").attr("transform",function(e,t){return"translate("+t*ee(e)+",0)"}),V.append("rect").attr("rx",2).attr("ry",2).attr("width",10).attr("height",10).style("fill",function(e){return te(e)}).on("click",y),V.append("text").attr("y",9).attr("x",12).style("font-size","12px").text(function(e){return e}),V[0].forEach(function(e){E[e.textContent].disabled&&(e.children[0].style.opacity=.2)})}function y(e){E[e].disabled=!E[e].disabled,E[e].disabled?d3.select(this).style("opacity",.2):d3.select(this).style("opacity",1),S()}function b(){A(),S()}function _(){var e=document.getElementById("OrderOptions"),t=e.options[e.selectedIndex].text;"+Add"===t||(console.log("== changing OrderBy "+t),C(),S(),T())}function w(){var e=document.getElementById("SideBarOptions"),t=e.options[e.selectedIndex].text;"+Add"===t||(console.log("== changing SideBar",t),T())}function k(){var e=document.getElementById("AlignOptions"),t=e.options[e.selectedIndex].text;return"--"===t?(x=d3.time.scale().range([0,TimeLineSize.width]),TimeScale=1,Xtitle="Year",xAxis=d3.svg.axis().scale(x).orient("bottom")):(x=d3.scale.linear().range([0,TimeLineSize.width]),TimeScale=U,Xtitle="Days",xAxis=d3.svg.axis().scale(x).orient("bottom").ticks(10).tickFormat(function(e){var t=0>e?-1:1;return Math.round(t*(Math.pow(2,Math.abs(e))-1)*100)/100})),{AlignBy:t,scale:x,timescale:TimeScale,title:Xtitle,axis:xAxis}}function S(){function e(e,n){("undefined"==typeof e||"undefined"==typeof n)&&console.log("ERROR: event dates not properly specified",e,n);var o="--"==r.AlignBy?r.scale(e.date):r.scale(a(e.date-P[e.ptID].offset,r.TimeScale)),i="--"==r.AlignBy?r.scale(n.date):r.scale(a(n.date-P[n.ptID].offset,r.TimeScale)),s=t(Z.indexOf(e.ptID))+u/(P[e.ptID].PatientHeight+1),l=i-o,c=u/P[n.ptID].PatientHeight,d=d3.rgb(te(e.name)),p=h.concat([n]),g=n.ptID;return 3>l&&(l=3),{id:g,x:o,y:s,height:c,width:l,fill:d,eventIDs:p}}console.log("======== DisplayPatients.TimeLineDisplay"),d=new Date,N=d.getTime(),console.log("plot Timelines start: ",N-I),I=N,F.selectAll("g").remove();var t=d3.scale.linear().range([TimeLineSize.height,0]),n=d3.svg.axis().scale(t).orient("left").ticks(0),r=k(),i=null,s=null,c=[];Z.filter(function(e){return P[e].showPatient}).forEach(function(e){var t=P[e].dateEvents.filter(function(e){return!E[e.name].disabled});if(t.length>0){c=c.concat(t);var n="--"==r.AlignBy?t[0].date:a(t[0].date-P[e].offset,r.TimeScale),o="--"==r.AlignBy?t[t.length-1].date:a(t[t.length-1].date-P[e].offset,r.TimeScale);(null===i||i>n)&&(i=n),(null===s||o>s)&&(s=o)}}),r.scale.domain([i,s]),t.domain([-2,Z.length+1]),F.append("g").attr("class","x axis").attr("transform","translate(0,"+TimeLineSize.height+")").call(r.axis).append("text").style("font-size","12px").text(r.title),F.append("g").attr("class","y axis").call(n).append("text").attr("transform","rotate(-90)").attr("y",2).attr("dy","-.71em").style("text-anchor","end").style("font-size","12px").text("Patients");var u=Math.max(Math.min(t(0)-t(1),20),3);console.log(u);var p=F.append("g").attr("class","hoverbar");
TimeLined3PlotBrush=d3.svg.brush().x(r.scale).y(t).on("brushend",l),F.call(TimeLined3PlotBrush);var g,h=[],f=[];c.forEach(function(t){"single"==t.eventOrder?f.push(e(t,t)):"start"==t.eventOrder?(h.length>0&&f.push(e(g,t)),g=t,h.push(t)):"end"==t.eventOrder&&(h=h.filter(function(e){return e.eventID!=t.eventID}),f.push(e(g,t)),g=t)});var v=F.append("g").selectAll("rect");v.data(f).enter().append("rect").attr("class","rect").attr("x",function(e){return e.x}).attr("rx",function(e){return 5}).attr("ry",function(e){return 5}).attr("width",function(e){return e.width}).attr("y",function(e){return e.y}).attr("height",function(e){return e.height}).attr("stroke",function(e){return e.fill}).attr("border-radius","20px").attr("fill",function(e){return e.eventIDs.length>1?"url(#diagonalHatch)":e.fill}).on("mouseover",function(e,n){p.append("rect").attr("x",0-2*L.width).attr("y",function(){return t(Z.indexOf(e.id))+u/(P[e.id].PatientHeight+1)}).attr("width",TimeLineSize.width+2*L.width+X.left).attr("height",function(){return u}).style("fill","grey").style("opacity",.3),q.style("left",function(){var e=$(window).width()-(d3.event.pageX+400);e=0>e?e:0;var t=d3.event.pageX+e+"px";return t}).style("top",d3.event.pageY+5+"px").style("height","250px").style("width","350px"),q.html(function(){var t="<span ><b>"+R[e.eventIDs[0].eventID].PatientID+": </b>("+R[e.eventIDs[0].eventID].study+")<br/>";for(n=0;n<e.eventIDs.length;n++){var a=R[e.eventIDs[n].eventID].Fields;t=t+"<br/><b>"+R[e.eventIDs[n].eventID].Name+"</b><br/>";for(var r in a)t="date"==r?a[r].length>1?t+r+": "+o(a[r][0])+", "+o(a[r][1])+"<br/>":t+r+": "+o(a[r])+"<br/>":t+r+": "+a[r]+"<br/>"}return t+"</span>"}),$("#tooltipDiv").removeClass("eventNoHover").addClass("eventHover")}).on("mouseout",function(e){p.select("rect").remove(),setTimeout(function(){$("#tooltipDiv").removeClass("eventHover").addClass("eventNoHover")},500)}).on("mousemove",function(){return q.style("top",d3.event.pageY+5+"px").style("left",function(){var e=$(window).width()-(d3.event.pageX+400);e=0>e?e:0;var t=d3.event.pageX+e+"px";return t})}),hub.enableTab(W),d=new Date,N=d.getTime(),console.log("plot Timelines finished: ",N-I),I=N}function T(){console.log("======== plotSideBar"),z.selectAll("g").remove();var e=d3.scale.linear().range([0,L.width]),t=d3.scale.linear().range([L.height,0]),n=d3.svg.axis().scale(e).orient("bottom"),a=d3.svg.axis().scale(t).orient("left").ticks(0),o="";t.domain([-2,Z.length+1]);var r=d3.max([d3.min([t(0)-t(1),20]),3]);console.log("PixelScale",r);var i=[],s=document.getElementById("SideBarOptions"),l=s.options[s.selectedIndex],c=l.text;if("Category"==l.parentNode.label);else if("Value"==l.parentNode.label){for(var d=P[Z[0]].calcEvents,u=-1,p=0;p<d.length;p++)if(d[p].name==c){u=p;break}-1!==u&&(i=D(u),o=i[0].timeScale)}e.domain([d3.min([d3.min(i,function(e){return e.width}),d3.min(i,function(e){return e.xBar})]),d3.max(i,function(e){return e.xBar+e.width})]).nice(),z.append("g").attr("class","x axis").attr("transform","translate(0,"+L.height+")").call(n).selectAll("text").style("text-anchor","end").style("font-size","12px").attr("dy",".55em").attr("dx","-.45em").attr("transform",function(e){return"rotate(-75)"}),z.append("g").append("text").attr("transform","translate(0,"+L.height+")").style("font-size","12px").text(o),z.append("g").attr("class","y axis").call(a).append("text").attr("transform","rotate(-90)").attr("y",2).attr("dy","-.71em").style("font-size","12px").style("text-anchor","end").text(c);z.append("g").selectAll("rect").data(i).enter().append("rect").attr("x",function(t){return e(t.xBar)}).attr("y",function(e){return t(e.yBar)+r/(P[e.id].PatientHeight+1)}).attr("width",function(t){return Math.abs(e(t.width)-e(0))}).attr("height",function(e){return r}).attr("fill",function(e){var t=d3.rgb("gray");return t}).on("mouseover",function(e,t){q.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px"),q.style("height","100px").style("width","150px"),q.text(e.id+": "+e.info),$("#tooltipDiv").removeClass("eventNoHover").addClass("eventHover")}).on("mouseout",function(){setTimeout(function(){$("#tooltipDiv").removeClass("eventHover").addClass("eventNoHover")},500)}).on("mousemove",function(){return q.style("top",d3.event.pageY-50+"px").style("left",d3.event.pageX+10+"px")})}function D(e){for(var t=[],n=0;n<Z.length;n++){var a=P[Z[n]].calcEvents[e],o=0,r=a.value;"undefined"==typeof a.value&&(r=0),a.value<0&&(o=a.value,r=Math.abs(a.value)),t.push({id:Z[n],info:a.value,xBar:o,yBar:n,width:r,timeScale:a.units})}return t}function M(e){var t=document.getElementById("OrderOptions"),n=t.options[t.selectedIndex],a=n.text;if(P[e].orderVal=null,"Date"==n.parentNode.label){for(var o=P[e].dateEvents,r=0;r<o.length;r++)if(o[r].name==a){P[e].orderVal=o[r].date;break}}else if("Value"==n.parentNode.label){calcEvents=P[e].calcEvents;for(var i=0;i<calcEvents.length;i++)if(calcEvents[i].name==a){var s=calcEvents[i].value;P[e].orderVal=s;break}}return P[e].orderVal}function C(){for(var e=document.getElementById("OrderOptions"),t=(e.options[e.selectedIndex].text,[]),n=0;n<Z.length;n++)M(Z[n]),t=r(Z[n],t);Z=t}function A(){var e=document.getElementById("AlignOptions"),t=e.options[e.selectedIndex].text;console.log("========Align Event: "+t);for(var n in P)if("--"==t)P[n].offset=0,P[n].showPatient=!0,M(n);else{P[n].offset=null,P[n].showPatient=!1;for(var a=P[n].dateEvents,o=0;o<a.length;o++)if(a[o].name==t){P[n].showPatient=!0,P[n].offset=a[o].date;break}}}var O,I,N,E,R,P,G,L,H,B,z,F,V,q,J="Send selection...",j=["Timelines"],U=864e5,W="patientTimeLinesDiv",Z=[],X={top:15,right:15,bottom:30,left:25},Y=["Birth","Encounter","Diagnosis","Procedure","Pathology","Radiation","Drug","Progression","Tests","Status","History","Absent"],K=["#17becf","#d62728","#8c564b","#ff7f0e","#7f7f7f","#e7969c","#9467bd","#1f77b4","#2ca02c","#bcbd22","#000000","#000000"],Q=[0,90,90,90,90,90,90,90,90,90,90,90],ee=d3.scale.ordinal().range(Q).domain(Y),te=d3.scale.ordinal().range(K).domain(Y);return{init:function(){hub.addOnDocumentReadyFunction(e),hub.registerSelectionDestination(j,W),hub.addMessageHandler("sendSelectionTo_Timelines",g),hub.addMessageHandler("DisplayPatientTimeLine",f),hub.addMessageHandler("TimelinesHandlePatientIDs",p),hub.addMessageHandler("datasetSpecified",c)}}};PatientTimeLine=TimeLineModule(),PatientTimeLine.init();var cyGbm,expressionData=[],cnvData=[],mutationData=[],gbmPathwaysModule=function(){function e(e,t){W=$("#gbmPathwaysDiv"),E=$("#cyGbmPathwaysDiv"),R=$("#gbmPathwaysStatusDiv"),Z=$("#gbmPathwaysButtonDiv"),z=$("#gbmPathwaysSelectLabel"),z.css("color","lightgray"),P=$("#gbmViewAbstractsButton"),P.button(),P.click(d),G=$("#gbmZoomSelectedButton"),G.button(),G.click(c),L=$("#gbmPathwaysSampleSelector"),L.change(M),H=$("#gbmPathwaysMovieButton"),H.button(),B=H.css("color"),H.prop("disabled",!0),H.css("color",X),F=$("#gbmPathwaysSlowerMovieButton"),F.button(),V=$("#gbmPathwaysFasterMovieButton"),V.button(),q=$("#gbmPathwaysMovieSpeedReadout"),q.text(Number(Y/1e3).toFixed(2)),V.click(function(){m(-250)}),F.click(function(){m(250)}),H.text("Play Movie"),H.click(y),j=$("#gbmPathwaysSearchBox"),U=hub.configureSendSelectionMenu("#gbmPathwaysSendSelectionMenu",[te],n,ee),U.attr("disabled",!0),o(),$(window).resize(l),hub.disableTab(ne)}function t(e){for(var t=[],n=e.filter("node:selected"),a=0;a<n.length;a++)t.push(n[a].data("name"));return t}function n(e){var n=U.val();console.log("CyMarkers send selections to "+n),U.val(ee);var a=t(cyGbm);if(0==a.length)return void console.log("no nodes selected!");var o="sendSelectionTo_"+n;payload={value:a,count:a.length,source:"markers and patients module"};var r={cmd:o,callback:"",status:"request",payload:payload};U.val(ee),hub.send(JSON.stringify(r))}function a(){for(var e=[],t=cyGbm.filter("node:selected"),n=0;n<t.length;n++)e.push(t[n].data("name"));return e}function o(){cyGbm=$("#cyGbmPathwaysDiv"),cyGbm.cytoscape({boxSelectionEnabled:!0,showOverlay:!1,minZoom:.01,maxZoom:8,layout:{name:"preset",fit:!0},ready:function(){console.log("cyGbm ready"),cyGbm=this,cyGbm.on("select","edge",function(e){var t=e.cyTarget;if(console.log("selected edge"),K){var n=t.data().pmid,a="http://www.ncbi.nlm.nih.gov/pubmed/?term="+n,o=!0;hub.openCenteredBrowserWindow(a,"pubmed abstract",800,600,o)}}),cyGbm.on("select","node",function(e){var t=0==a().length;U.attr("disabled",t)}),cyGbm.on("unselect","node",function(e){var t=0==a().length;U.attr("disabled",t)}),j.keydown(b),cyGbm.edges().unselectify(),console.log("cyGbm.reset"),cyGbm.reset(),l()}}).cytoscapePanzoom({})}function r(e){if(console.log("--- Module.gbmPathways: displayPathway"),"success"==e.status){console.log("nchar(network): "+e.payload.length),s=e.payload,XXX=e.payload,console.log("      1:40: "+s.substring(1,40));var t=JSON.parse(e.payload);cyGbm.remove(cyGbm.edges()),cyGbm.remove(cyGbm.nodes()),console.log(" after JSON.parse, json.length: "+t.length),console.log("  about to add json.elements"),cyGbm.add(t.elements),console.log("  about to add  json.style"),cyGbm.style(t.style),cyGbm.nodes().unselect(),cyGbm.nodes().map(function(e){e.data({degree:e.degree()})});hub.uniqueElementsOfArray(cyGbm.edges().map(function(e){return e.data("edgeType")}));cyGbm.resize(),cyGbm.fit(50),console.log("concluding displayPathway in Module.gbmPathways"),cyGbm.edges().show(),U.prop({disabled:!0}),hub.enableTab(ne),l()}else console.log("displayPathway error: "+e.payload)}function l(){W.width(.95*$(window).width()),W.height(.95*$(window).width()),Z.width(.95*$(window).width()),Z.height(80),E.width(.95*$(window).width()),E.height(.8*$(window).height()),cyGbm.resize(),cyGbm.fit(50)}function c(){cyGbm.fit(cyGbm.$(":selected"),50)}function d(){K?(K=!1,P.button("option","label","Enable Abstracts")):(K=!0,P.button("option","label","Disable Abstracts"))}function u(e){var t=Object.keys(e[0]);geneCount=t.length-1,t=t.slice(0,geneCount);var n=[];max=e.length,namedList={};for(var a=0;a<max;a++)row=e[a],tissueName=row.rowname[0],n.push(tissueName),namedList[tissueName]=row;return result={genes:t,tissues:n,values:namedList},result}function p(e){console.log("=== entering handleIncomingIdentifiers for gbm"),console.log("status: "+e.status);var t=e.payload.value;"string"==typeof t&&(t=[t]);var n="gbm pathway received "+t.length+" identifiers";I(n),console.log(n),console.log(JSON.stringify(t));var a=t.map(function(e){return e.toUpperCase()}),o=cyGbm.nodes().map(function(e){return e.id()}),r=o.filter(function(e){return a.indexOf(e)>=0});r.length>0?(hub.raiseTab("gbmPathwaysDiv"),console.log(" incoming ids matched "+r.length+" gene names"),console.log(JSON.stringify(r)),v(r)):alert("None of the selected ids are recognized by the GBM Pathways tab.")}function g(e){console.log("=== Module.gbmPathways handleOverlappingTissueIdentifiers"),payload=JSON.parse(e.payload),recognizedIDs=payload.recognized,"string"==typeof recognizedIDs&&(recognizedIDs=[recognizedIDs]),unrecognizedIDs=payload.unrecognized,"string"==typeof unrecognizedIDs&&(unrecognizedIDs=[unrecognizedIDs]),recognizedIDs.length>0?(_(recognizedIDs,f()),w(recognizedIDs,f()),k(recognizedIDs,f())):unrecognizedIDs.length>0&&(errorMessage="No overlap with pathway genes or tissue sample IDs:  <br><br>"+unrecognizedIDs.join(", "),title=unrecognizedIDs.length+" unrecognized identifiers",$("<div />").html(errorMessage).dialog({title:title,width:600,height:300}))}function h(){nodes=cyGbm.nodes(),result=[];for(var e=0;e<nodes.length;e++)result.push(nodes[e].data().label);return result}function f(){nodes=cyGbm.filter("node"),result=[];for(var e=0;e<nodes.length;e++)sym=nodes[e].data().geneSymbol,"undefined"!=typeof sym&&result.push(sym);return result}function v(e){"string"==typeof e&&(e=[e]);for(var t=0;t<e.length;t++)s="cyGbm.filter('node[name=\""+e[t]+"\"]').select()",JAVASCRIPT_EVAL(s)}function m(e){0>Y+e||(console.log("currentMovieSpeed: "+Y),Y+=e,console.log("currentMovieSpeed: "+Y),q.text(Number(Y/1e3).toFixed(2)),Q&&(clearInterval(J),J=setInterval(oneFrame,Y)))}function y(){allCurrentTissues=L.children().map(function(){return $(this).val()}).get(),currentTissueIndex=0,oneFrame=function(){tissueIndex=currentTissueIndex%allCurrentTissues.length,tissueName=allCurrentTissues[tissueIndex],currentTissueIndex+=1,L.val(tissueName),M()},Q?(Q=!1,clearInterval(J),H.text("Play Movie")):(Q=!0,H.text("Stop Movie"),J=setInterval(oneFrame,Y))}function b(e){var t=e.keyCode||e.which;if(13==t){searchString=j.val(),names=h(),matches=[];for(var n=0;n<names.length;n++)names[n].beginsWith(searchString)&&v([names[n]])}}function _(e,t){msg={cmd:"get_mRNA_data",callback:"handle_gbmPathways_mRNA_data",status:"request",payload:{entities:e,features:t}},msg.json=JSON.stringify(msg),hub.send(msg.json)}function w(e,t){msg={cmd:"get_cnv_data",callback:"handle_gbmPathways_cnv_data",status:"request",payload:{entities:e,features:t}},msg.json=JSON.stringify(msg),hub.send(msg.json)}function k(e,t){msg={cmd:"get_mutation_data",callback:"handle_gbmPathways_mutation_data",status:"request",payload:{entities:e,features:t}},msg.json=JSON.stringify(msg),hub.send(msg.json)}function S(e){if(L.empty(),0==e.length)return void alert("gbmPathways received empty tissueIDs list");e.unshift("neutral");for(var t=0;t<e.length;t++)tissueName=e[t],optionMarkup="<option>"+tissueName+"</option>",L.append(optionMarkup)}function T(e){if(console.log("handling mRNA data"),hub.raiseTab("gbmPathwaysDiv"),"success"==e.status){var t=JSON.parse(e.payload.mtx);expressionData=u(t),console.log("handle_mRNA_data, success, rows: "+expressionData.length),S(expressionData.tissues),H.prop("disabled",!1),H.css("color",B),z.css("color","black")}else expressionData=[],console.log("handle_mRNA_data, failure, rows: "+expressionData.length)}function x(e){if(console.log("handling cnv data"),"success"==e.status){var t=JSON.parse(e.payload.mtx);cnvData=u(t)}else cnvData=[]}function D(e){if(console.log("handling mutation data"),"success"==e.status){var t=JSON.parse(e.payload.mtx);mutationData=u(t)}else mutationData=[]}function M(){tissueID=L.val(),A(tissueID)}function C(e){infoNodeID=cyGbm.filter('node[canonicalName="info.node"]').data("id"),noa={},noa[infoNodeID]={label:e},cyGbm.batchData(noa)}function A(e){C(e);var t={};if("neutral"==e){for(console.log(" will display neutral values of expression, copynumber, mutation"),ids=[],allNodes=cyGbm.nodes(),i=0;i<allNodes.length;i++)node=allNodes[i],id=node.data("id"),Object.keys(node.data()).indexOf("geneSymbol")>=0&&(geneSymbol=node.data("geneSymbol"),ids.push(id),t[id]={score:0,label:geneSymbol,copyNumber:0});return void cyGbm.batchData(t)}if(expressionData.tissues.indexOf(e)<0)return void alert(tissueId+" not found in current expressionData");mRNA=expressionData.values,genes=expressionData.genes,tissues=expressionData.tissues,t={};for(var n=0;n<genes.length;n++)gene=genes[n],newScore=mRNA[e][gene][0],filterString='[geneSymbol="'+gene+'"]',nodeID=cyGbm.nodes(filterString)[0].data("id"),t[nodeID]={score:newScore};cyGbm.batchData(t),cnv=cnvData.values,genes=cnvData.genes,tissues=cnvData.tissues,t={};for(var n=0;n<genes.length;n++)gene=genes[n],newCopyNumber=cnv[e][gene][0],filterString='[geneSymbol="'+gene+'"]',nodeID=cyGbm.nodes(filterString)[0].data("id"),t[nodeID]={copyNumber:newCopyNumber};cyGbm.batchData(t),mut=mutationData.values,t={};for(var n=0;n<genes.length;n++)gene=genes[n],newMutation=mut[e][gene][0],filterString='node[geneSymbol="'+gene+'"]',nodeID=cyGbm.filter(filterString).id(),null==newMutation?(newGeneLabel=gene,newNodeType="gene"):(newGeneLabel=gene+" ("+newMutation+")",newNodeType="mutation"),t[nodeID]={label:newGeneLabel,nodeType:newNodeType};cyGbm.batchData(t)}function O(e){console.log("Module.gbm datasetSpecified"),console.log(e.payload);var t=e.payload,n=t.rownames,a="gbmPathways.json.RData";if($.inArray(a,n)>=0){var o={cmd:"getPathway",callback:"displayGbmPathway",status:"request",payload:"g.gbmPathways.json"};hub.send(JSON.stringify(o))}}function I(e){console.log("posting new status to gbmPathway status div: "+e),R.text(e)}function N(e){document.getElementById("gbmPathwaysDateModified").innerHTML=e.payload}var E,R,P,G,L,H,B,z,F,V,q,J,j,U,W,Z,X="lightGray",Y=750,K=!1,Q=!1,ee="Send selection...",te="gbmPathways",ne="gbmPathwaysDiv",ae=[te];return{init:function(){hub.addMessageHandler("DisplayGbmPathwaysModifiedDate",N),hub.addMessageHandler("handle_gbmPathways_mRNA_data",T),hub.addMessageHandler("handle_gbmPathways_cnv_data",x),hub.addMessageHandler("handle_gbmPathways_mutation_data",D),hub.addMessageHandler("gbmPathwaysHandleOverlappingTissueIdentifiers",g),hub.addMessageHandler("sendSelectionTo_gbmPathways",p),hub.registerSelectionDestination(ae,ne),hub.addMessageHandler("datasetSpecified",O),hub.addMessageHandler("displayGbmPathway",r),hub.addOnDocumentReadyFunction(e)}}};gbmPathway=gbmPathwaysModule(),gbmPathway.init();var cwMarkers,markersTester,markersAndTissuesModule=function(){function e(){J=$("#cyMarkersDiv"),q=$("#markersAndPatientsStatusDiv"),le=hub.configureSendSelectionMenu("#cyMarkersSendSelectionsMenu",[pe],n,ve),K=$("#markersFitViewButton"),K.click(function(){cwMarkers.fit(50)}),ee=$("#markersZoomSelectedButton"),ee.click(k),Q=$("#markersHideEdgesButton"),Q.click(_),hub.disableButton(Q),markersShowEdgesFromButton=$("#markersShowEdgesFromSelectedButton"),markersShowEdgesFromButton.click(M),hub.disableButton(markersShowEdgesFromButton),se=$("#cyMarkersTumorCategorizationsMenu"),se.empty(),se.append("<option>"+ue+"</option>"),se.change(h),ie=$("#cyMarkersOperationsMenu"),ie.change(v),ie.empty(),ie.append("<option>Network Operations...</option>");for(var e=["Show All Edges","Show Edges from Selected Nodes","Hide All Edges","Invert Node Selection","Clear Selections","Select All Connected Nodes","Select All Nodes with Selected Edges","Hide Unselected Nodes","Show All Nodes","Restrict Next Ops to Selected Nodes"],a=0;a<e.length;a++){var i="<option>"+e[a]+"</option>";ie.append(i)}ce=$("#markerLayouts"),ce.change(o),W=$("#cyMarkersShowEdgesButton"),W.click(T),Z=$("#cyMarkersShowAllEdgesButton"),Z.click(w),Y=$("#cyMarkersSFNButton"),Y.click(y),X=$("#cyMarkersClearSelectionButton"),X.click(m),U=$("#cyMarkersHideEdgesButton"),U.click(_),j=$("#markersAndTissuesSearchBox"),oe=$("#markersEdgeTypeSelector"),oe.chosen(),re=$("#markersAndTissuesMouseOverReadout"),r(),$(window).resize(l),te=$("#markersSubSelectButton"),te.click(p),setInterval(t,500),hub.disableTab(ge)}function t(){var e=cwMarkers.nodes("node:selected"),t=e.length;$("#markersSelectionCountReadout").val(t);var n=cwMarkers.nodes("node[nodeType='patient']:selected"),a=n.length;0===t?(hub.disableButton(le),hub.disableButton(markersShowEdgesFromButton),hub.disableButton(ee)):(hub.enableButton(le),hub.enableButton(markersShowEdgesFromButton),hub.enableButton(ee));var o=n.map(function(e){return e.data().category}),r=o.filter(function(e){return e}).length>0;a>0&r?hub.enableButton(te):hub.disableButton(te);var i=cwMarkers.edges().fnFilter(function(e){return e.visible()}).fnFilter(function(e){return"chromosome"!=e.data("edgeType")}).length;i>0?hub.enableButton(Q):hub.disableButton(Q)}function n(e){var t=le.val();console.log("CyMarkers send selections to "+t),le.val(ve);var n=D(cwMarkers);if(0===n.length)return void console.log("no nodes selected!");var a="sendSelectionTo_"+t;payload={value:n,count:n.length,source:"markers and patients module"};var o={cmd:a,callback:"",status:"request",payload:payload};le.val(ve),hub.send(JSON.stringify(o))}function a(e){console.log("--- configureLayoutsMenu"),e.append("<option>Layouts...</option>"),e.append("<option> Save Current</option>");var t=JSON.stringify(cwMarkers.nodes().map(function(e){var t={id:e.id(),position:e.position()};return t}));localStorage.markersDefault=t;for(var n=Object.keys(localStorage),a=0;a<n.length;a++)null!==n[a].match("markers")&&e.append("<option>"+n[a]+"</option>")}function o(e){var t=ce.val();if("Save Current"==t){var n=Math.floor((new Date).getTime()/1e3);newName="markers."+(n-1420414900);var a=cwMarkers.nodes().map(function(e){var t={id:e.id(),position:e.position()};return t});return currentLayout=JSON.stringify(a),localStorage[newName]=currentLayout,ce.append("<option>"+newName+"</option>"),void ce.val(newName)}if(Object.keys(localStorage).indexOf(t)>=0){var o;o=JSON.parse(localStorage[t]),cwMarkers.nodes().positions(function(e,t){return{x:o[e].position.x,y:o[e].position.y}})}ce.val("Layouts...")}function r(){cwMarkers=$("#cyMarkersDiv"),cwMarkers.cytoscape({hideEdgesOnViewport:!1,hideLabelsOnViewport:!1,boxSelectionEnabled:!0,showOverlay:!1,minZoom:.001,maxZoom:1e3,layout:{name:"preset",fit:!0},ready:function(){console.log("cwMarkers ready"),cwMarkers=this,ne=cwMarkers.zoom();var e=c(d,20);cwMarkers.on("zoom",e),cwMarkers.on("pan",e),cwMarkers.on("mouseover","node",function(e){var t=e.cyTarget;re.val(t.id())}),cwMarkers.on("mouseout","node",function(e){e.cyTarget;re.val("")}),cwMarkers.on("mouseover","edge",function(e){var t=e.cyTarget,n=t.data(),a=n.edgeType+": "+n.source+" - "+n.target,o=n.mutation;"string"==typeof o&&(a=o+" "+a),re.val(a)}),cwMarkers.filter("edge[edgeType='chromosome']").style({"curve-style":"bezier"}),cwMarkers.filter("edge[edgeType='chromosome']").show(),j.keydown(L),console.log("cwMarkers.reset"),cwMarkers.reset(),l(),cwMarkers.edges().selectify(),a(ce),cwMarkers.fit(50)}})}function l(){J.width(.95*$(window).width()),J.height(.8*$(window).height()),cwMarkers.resize(),cwMarkers.fit(50)}function c(e,t,n){var a;return function(){var o=this,r=arguments,i=function(){a=null,n||e.apply(o,r)},s=n&&!a;clearTimeout(a),a=setTimeout(i,t),s&&e.apply(o,r)}}function d(e){var t=($("#cyMarkersDiv").queue(),cwMarkers.zoom()/ne);if(console.log("zoomRatio: "+t),1>t)return void u();var n=cwMarkers.extent(),a=function(e){if(e.data("landmark"))return!1;var t=e.boundingBox(),a=(t.x1>=n.x1&&t.x1<=n.x2)|(t.x2>=n.x1&&t.x2<=n.x2);if(!a)return!1;var o=(t.y1>=n.y1&&t.y1<=n.y2)|(t.y2>=n.y1&&t.y2<=n.y2);return o},o=cwMarkers.nodes().fnFilter(function(e){return a(e)});if(console.log("visibleNode count: "+o.length),o.length>400)return void u();1+cwMarkers.zoom()-ae;ae=cwMarkers.zoom();var r=(cwMarkers.width()/cwMarkers.extent().h,cwMarkers.extent().h/60);.6>r&&(r=.6);var i=r+"px",s=cwMarkers.extent().h/600+"px";cwMarkers.edges().style({width:s});var l,c,d,p=1.5;cwMarkers.batch(function(){o.map(function(e){l=p*e.data("trueWidth")/t,c=p*e.data("trueHeight")/t,d=e.id(),e.data({zoomed:!0}),e.style({width:l,height:c,label:d,"font-size":i,"border-width":s})})})}function u(){var e=cwMarkers.nodes("[zoomed]");cwMarkers.edges().style({width:"1px"}),e.map(function(e){e.style({width:e.data("trueWidth"),height:e.data("trueHeight"),zoomed:!1,"border-width":"1px","font-size":"3px"})})}function p(){var e=cwMarkers.nodes("node[nodeType='patient']:selected"),t=jQuery.unique(e.map(function(e){return e.data("category")})),n=jQuery.unique(e.map(function(e){return e.style("background-color")})),a="<form action=''>";for(i=0;i<t.length;i++){var o=t[i],r=n[i],s="[category='"+o+"']:selected",l=cwMarkers.nodes(s).length,c="cb"+i,d="<html><body><input id='"+c+"' type='checkbox' class='markersSubSelectRadioButton' name='"+o+"' style='background':'"+r+"' checked> <label for='"+c+"' style='color:"+r+"'>"+o+" ("+l+")</label><br></body></html>";a+=d}a+="</form>",button="<br><br><button id='markersSubSelectCloseButton'>Close</button>",a+=button;$('<div id="markersSubSelectDialog" />').html(a).dialog({title:"Subselect by Sample Category",width:"500px"});$("#markersSubSelectCloseButton").click(function(){console.log("about to remove subselect dialog"),$("#markersSubSelectDialog").remove()}),$(".markersSubSelectRadioButton").click(function(t){var n=this.name,a=this.checked,o=e.filterFn(function(e){return e.data("category")===n});a?o.select():o.unselect()})}function g(){var e=cwMarkers.nodes("node[nodeType ='patient']");cwMarkers.batch(function(){e.map(function(e){"category"in e.data()&&delete e.data().category})});var t=cwMarkers.style().json(),n=t.filter(function(e){return e.selector.indexOf("node[category")});cwMarkers.style(n)}function h(){var e=se.children().map(function(){return $(this).val()}).get(),t=e[0],n=se.val();if(console.log("--- requestTumorCategorization, name: "+n),n===t||"Clear"===n)return void g();console.log("apply "+n),hub.logEventOnServer(pe,"markersApplyTumorCategorization","request","");var a={cmd:"getSampleCategorization",callback:"markersApplyTumorCategorization",status:"request",payload:n};hub.send(JSON.stringify(a))}function f(e){console.log("=== applyTumorCategorization");var t=cwMarkers.nodes("[nodeType='patient']"),n=e.payload.rownames,a=e.payload.tbl,o={};a.forEach(function(e){o[e[0]]=e[1]}),categoryRuleNames=Object.keys(o),categoryRuleNames.filter(function(e){return"null"!==e}),categoryRuleNames.filter(function(e){return null!==e});var r=[];categoryRuleNames.forEach(function(e){var t="node[category='"+e+"']";color=o[e],console.log(t+": "+color),r.push({selector:t,style:{"background-color":color}});var n=t+":selected";r.push({selector:n,style:{"border-color":"red","background-color":color,"border-width":"10px"}})}),r.push({selector:"node[category='unassigned']",style:{"background-color":"lightgray"}}),r.push({selector:"node[category='unassigned']:selected",style:{"border-color":"red","background-color":"lightgray","border-width":"10px"}}),hub.logEventOnServer(pe,"markersApplyTumorCategorization","data received",""),console.log("starting tumorsInGraph.forEach"),cwMarkers.batch(function(){t.forEach(function(e,t){var o=e.id(),r=n.indexOf(o);if(r>=0){var i=a[r][0];a[r][1];e.data({category:i})}else e.data({category:"unassigned"})})}),console.log("ending tumorsInGraph.forEach");var i=cwMarkers.style().json(),s=i.filter(function(e){return e.selector.indexOf("node[category")}),l=s.concat(r);cwMarkers.style(l),B("applyTumorCategorization complete"),hub.logEventOnServer(pe,"markersApplyTumorCategorization","node category assigned","")}function v(){var e=ie.val();switch(e){case"Show All Edges":w();break;case"Show Edges from Selected Nodes":M();break;case"Hide All Edges":_();break;case"Invert Node Selection":b();break;case"Clear Selections":cwMarkers.filter("node:selected").unselect();break;case"Select All Connected Nodes":O();break;case"Select All Nodes with Selected Edges":I();break;case"Hide Unselected Nodes":cwMarkers.filter("node:unselected").hide();break;case"Show All Nodes":cwMarkers.filter("node:hidden").show();break;case"Restrict Next Ops to Selected Nodes":N();break;default:console.log("unrecoginized graph operation requested from menu: "+e)}ie.val("Network Operations...")}function m(){cwMarkers.elements().unselect()}function y(){selectedNodes=cwMarkers.filter("node:selected"),A(cwMarkers,selectedNodes)}function b(){selected=cwMarkers.filter("node:selected"),unselected=cwMarkers.filter("node:unselected"),selected.unselect(),unselected.select()}function _(){cwMarkers.edges().fnFilter(function(e){return"chromosome"!=e.data("edgeType")}).hide()}function w(){var e=oe.val();if(console.log("edgeTypeToDisplay: "+e),null!==e)for(var t=0;t<e.length;t++){var n=e[t];selectionString='[edgeType="'+n+'"]',cwMarkers.edges(selectionString).show()}}function k(){cwMarkers.fit(cwMarkers.$(":selected"),100)}function S(e){console.log("Module.markers, handleIncomingIdentifiers");var t=e.payload.value;"string"==typeof t&&(t=[t]),intersectingIDs=hub.intersectionOfArrays(t,E()),console.log("found ids: "+intersectingIDs.length),intersectingIDs.length>0?G(intersectingIDs):(errorMessage="No overlap with genes or tissue sample IDs:  <br><br>"+t.join(", "),title=t.length+" unrecognized identifiers",console.log("+++++++++++ creating error div"),$('<div id="markersIncomingIdentifiersErrorDialog" />').html(errorMessage).dialog({title:title,width:600,height:300})),console.log("about to post status from incoming identifiers"),B("incoming identifiers: "+t.length),hub.raiseTab(ge)}function T(){_();var e=oe.val();if(null===e)return void _();var t=x(cwMarkers);t.length>0&&A(cwMarkers,t)}function x(e){ids=[],noi=e.filter("node:selected");for(var t=0;t<noi.length;t++)ids.push(noi[t].data("id"));return ids}function D(e){for(var t=[],n=e.filter("node:selected"),a=0;a<n.length;a++)t.push(n[a].data("name"));return t}function M(){function e(e,t){var n=e.filter(function(e){return-1!=t.indexOf(e)}).length;return n>0}var t=de,n=cwMarkers.nodes("node:selected"),a=n.neighborhood(),o=a.filterFn(function(e){return e.isEdge()?e:void 0});return o=o.fnFilter(function(e){return oe.val().indexOf(e.data("edgeType"))>=0}),0===t.length?(o.show(),void B("showEdgesFromSelectedNodes")):(o.filterFn(function(n){var a=n.connectedNodes().map(function(e){return e.id()});return e(a,t)}).show(),void B("showEdgesFromSelectedNodes"))}function C(e,t){var n=function(e){return"chromosome"!==e.data("edgeType")};eoi=t.filterFn(n);for(var a=[],o=0;o<eoi.length;o++){edge=eoi[o],targetID=edge.target().data("id"),sourceID=edge.source().data("id");var r='[id="'+sourceID+'"]',i='[id="'+targetID+'"]';a.push(r),a.push(i)}var s=e.nodes(a.join());s.select()}function A(e,t){var n=oe.val();if(console.log("=== showEdgesForNodes, edgeType count: "+n.length),0!==n.length){var a=[];setTimeout(function(){for(var o=0;o<n.length;o++)for(var r=n[o],i=0;i<t.length;i++){var s=t[i].data("id"),l='[edgeType="'+r+'"][source="'+s+'"]',c='[edgeType="'+r+'"][target="'+s+'"]';a.push(l),a.push(c)}filter=a.join();var d=e.edges(filter);d.length>0&&d.show()},0)}}function O(){var e=cwMarkers.filter("edge:visible");e=e.filterFn(function(e){return"chromosome"!==e.data("edgeType")}),e.length>0&&C(cwMarkers,e)}function I(){if(edges=cwMarkers.filter("edge:selected"),console.log(" selected edge count: "+edges.length),0!==edges.length)for(var e=0;e<edges.length;e++)P(edges[e].target().data("name")),P(edges[e].source().data("name"))}function N(){var e=cwMarkers.nodes("node:selected");de=0===e.length?[]:e.map(function(e){return e.id()})}function E(){return cwMarkers.nodes().map(function(e){return e.id()})}function R(){return E().map(function(e){return e.toUpperCase()})}function P(e){console.log("Module.markers::selectNodes"),"string"==typeof e&&(e=[e]);for(var t=cwMarkers.nodes().map(function(e){return e.id()}),n=t.map(function(e){return e.toUpperCase()}),a=0;a<e.length;a++){var o=e[a].toUpperCase(),r=n.indexOf(o);if(r>=0){var i=t[r],s="cwMarkers.filter('node[id=\""+i+"\"]').select()";JAVASCRIPT_EVAL(s)}}B("nodes selected: "+t.length)}function G(e){"string"==typeof e&&(e=[e]),console.log("about to select nodes by id: "+e.length),console.log(e);for(var t=0;t<e.length;t++)s="cwMarkers.filter('node[id=\""+e[t]+"\"]').select()",console.log(s),JAVASCRIPT_EVAL(s)}function L(e){var t=e.keyCode||e.which;if(13==t){var n=j.val().toUpperCase();if(0===n.length)return;console.log("searchString: "+n);var a=E(),o=R(),r=o.filter(function(e){return 0===e.indexOf(n)}),i=r.map(function(e){return o.indexOf(e)}),s=i.map(function(e){return a[e]});P(s)}}function H(e){if(console.log("--- Module.markers: displayMarkersNetwork"),hub.logEventOnServer(pe,"display markers network","data received",""),"success"==e.status){console.log("nchar(network): "+e.payload.length);var t=JSON.parse(e.payload);cwMarkers.remove(cwMarkers.edges()),cwMarkers.remove(cwMarkers.nodes()),console.log(" after JSON.parse, json.length: "+t.length),console.log("  about to add json.elements"),cwMarkers.add(t.elements),cwMarkers.style(t.style),cwMarkers.edges().hide(),cwMarkers.filter("edge[edgeType='chromosome']").style({"curve-style":"bezier"}),cwMarkers.filter("edge[edgeType='chromosome']").show(),cwMarkers.nodes().unselect(),cwMarkers.nodes().map(function(e){e.data({degree:e.degree(),trueWidth:e.width(),trueHeight:e.height()})});var n=hub.uniqueElementsOfArray(cwMarkers.edges().map(function(e){return e.data("edgeType")}));z(n),cwMarkers.fit(20);var a=JSON.stringify(cwMarkers.nodes().map(function(e){return{id:e.id(),position:e.position()}}));localStorage.markersDefault=a,he=cwMarkers.nodes("[nodeType='patient']").style("background-color"),hub.logEventOnServer(pe,"display markers network","complete",""),
hub.logEventOnServer(pe,"getSampleCategorizationNames","request","");var o={cmd:"getSampleCategorizationNames",callback:"configureSampleCategorizationMenu",status:"request",payload:""};hub.send(JSON.stringify(o))}else console.log("displayMarkersNetwork error: "+e.payload)}function B(e){q.text(e)}function z(e){var t=$("#markersEdgeTypeSelector");t.find("option").remove(),t.trigger("chosen:updated"),e=e.filter(function(e){return"chromosome"!==e});for(var n=0;n<e.length;n++){var a=e[n],o="<option value='"+a+"' class='btn-info' selected>"+a+"</option>";$("#markersEdgeTypeSelector").append(o)}$("#markersEdgeTypeSelector").trigger("chosen:updated")}function F(e){var t=e.payload;hub.logEventOnServer(pe,"display markers network","request","");var n={cmd:"getMarkersNetwork",callback:"displayMarkersNetwork",status:"request",payload:t};hub.send(JSON.stringify(n))}function V(e){console.log("=== configureSampleCategorizationMenu"),se.empty();var t=e.payload;"string"==typeof t&&(t=[t]);var n="Tumor Groups...";se.append("<option>"+n+"</option>"),se.append("<option>Clear</option>");for(var a=0;a<t.length;a++)se.append("<option>"+t[a]+"</option>");se.val(n),hub.logEventOnServer(pe,"getSampleCategorizationNames","complete",""),hub.enableTab(ge),B("markers network displayed")}var q,J,j,U,W,Z,X,Y,K,Q,ee,te,ne,ae,oe,re,ie,se,le,ce,de=[],ue="Tumor Groups...",pe="MarkersAndPatients",ge="markersAndPatientsDiv",he="black",fe=[pe],ve="Send selection...";return{init:function(){hub.addMessageHandler("sendSelectionTo_MarkersAndPatients",S),hub.registerSelectionDestination(fe,ge),hub.addMessageHandler("datasetSpecified",F),hub.addMessageHandler("displayMarkersNetwork",H),hub.addMessageHandler("configureSampleCategorizationMenu",V),hub.addMessageHandler("markersApplyTumorCategorization",f),hub.addOnDocumentReadyFunction(e)}}};markersModule=markersAndTissuesModule(),markersModule.init();var SurvivalModule=function(){function e(){p=$("#survivalCurveDiv"),g=$("#survivalImageArea"),u=$("#survivalStatusDiv"),$("#survivalCurveDiv").css("display","none"),$(window).resize(t),t(),hub.disableTab(h)}function t(){var e=.8*$(window).height(),t=.95*$(window).width();p.width(t),p.height(e),g.width(t),g.height(e)}function n(e){if("success"==e.status){var t=e.payload;o(t,"")}else console.log("survival handlePatientIDs about to call alert: "+e),alert(e.payload)}function a(e){var t=e.payload.value,n=e.payload.count;e.payload.source;"string"==typeof t&&(t=[t]),console.log("Survival module, "+e.cmd+" count: "+n),e={cmd:"canonicalizePatientIDsInDataset",callback:"survivalHandlePatientIDs",status:"request",payload:t},hub.send(JSON.stringify(e))}function o(e,t){console.log("Survival module, hub.send 'calculateSurvivalCurves' for %d patientIDs",e.length),$("#survivalInstructions").css("display","none"),$("#survivalCurveDiv").css("display","block");var n={sampleIDs:e,title:t},a={cmd:"calculateSurvivalCurves",callback:"displaySurvivalCurves",status:"request",payload:n};hub.send(JSON.stringify(a))}function r(e){u.text(e)}function i(e){var t=e.payload;document.getElementById("survivalImageArea").src=t,hub.raiseTab(h),r("image loaded")}function s(e){console.log("Module.survival, specifyCurrentDataset: "+e);var t={cmd:"specifyCurrentDataset",callback:"survivalDatasetSpecified",status:"request",payload:e};hub.send(JSON.stringify(t))}function l(e){console.log("--- Module.survival, datasetSpecified: "+e.payload),hub.enableTab(h),document.getElementById("survivalImageArea").src=""}function c(){var e=["TCGA.06.6693","TCGA.12.1088","TCGA.02.0113","TCGA.02.0114","TCGA.08.0344"],t=["TCGA.02.0001","TCGA.02.0003","TCGA.02.0006","TCGA.02.0007","TCGA.02.0009","TCGA.02.0010","TCGA.02.0011","TCGA.02.0014","TCGA.02.0021","TCGA.02.0024","TCGA.02.0027","TCGA.02.0028","TCGA.02.0033","TCGA.02.0034","TCGA.02.0037","TCGA.02.0038","TCGA.02.0043","TCGA.02.0046","TCGA.02.0047","TCGA.02.0052","TCGA.02.0054","TCGA.02.0055","TCGA.02.0057","TCGA.02.0058","TCGA.02.0060","TCGA.06.0875","TCGA.06.0876","TCGA.06.0877","TCGA.06.0878","TCGA.06.0879","TCGA.06.0881","TCGA.06.0882","TCGA.12.0670","TCGA.12.0818","TCGA.12.0819","TCGA.12.0820","TCGA.12.0821","TCGA.12.0822","TCGA.12.0826","TCGA.12.0827"];return t.push(e),t}function d(e){"undefined"==typeof e&&(e=3),s("TCGAgbm");for(var t=c(),n=t.length-1,a=0;e>a;a++){for(var r=[],i=hub.getRandomInt(4,n+1),l=0;i>l;l++)r.push(t[hub.getRandomInt(0,n)]);o(r,"rep "+a)}}var u,p,g,h="survivalDiv",f=["survival"];return{init:function(){hub.addOnDocumentReadyFunction(e),hub.registerSelectionDestination(f,h),hub.addMessageHandler("datasetSpecified",l),hub.addMessageHandler("survivalDatasetSpecified",l),hub.addMessageHandler("displaySurvivalCurves",i),hub.addMessageHandler("sendSelectionTo_survival",a),hub.addMessageHandler("survivalHandlePatientIDs",n)},sat:d}},survival=SurvivalModule();survival.init();var PCAModule=function(){function e(){I=$("#pcaDisplay"),N=d3.select("#pcaDisplay"),r(),G=$("#pcaTestingOutputDiv"),$(window).resize(r),H=$("#pcaClearSelectionButton"),H.button(),H.click(p),B=$("#pcaCalculateButton"),B.button(),$("#pcaDisplay").css("display","none"),B.click(g),z=$("#pcaUseAllSamplesButton"),z.button(),z.click(o),hub.disableButton(z),F=$("#pcaGeneSetSelector"),F.change(function(){console.log("gene set is now "+F.val())}),P=$("#pcaTextDisplayDiv"),L=hub.configureSendSelectionMenu("#pcaSendSelectionsMenu",W,s,U),hub.disableTab(J)}function t(){console.log("=== requestGeneSetNames"),callback="pcaHandleGeneSetNames",msg={cmd:"getGeneSetNames",callback:callback,status:"request",payload:""},hub.send(JSON.stringify(msg))}function n(e){console.log("=== handleGeneSetNames"),newNames=e.payload,a(newNames)}function a(e){if(console.log("Module.pca:addGetSetNamesToMenu"),F.empty(),0==e.length)return void c("addGeneSetNamesToMenu: geneSetNames.length == 0");"string"==typeof e&&(e=[e]);for(var t=0;t<e.length;t++)optionMarkup="<option>"+e[t]+"</option>",F.append(optionMarkup);c("addGeneSetNamesToMenu: complete"),hub.enableTab(J)}function o(){V=null,hub.disableButton(z)}function r(){I.width(.95*$(window).width()),I.height(.8*$(window).height()),q||m(A)}function i(){x1=O[0][0],y1=O[0][1],x2=O[1][0],y2=O[1][1];for(var e=[],t=0;t<A.length;t++)px=A[t][0],py=A[t][1],px>=x1&px<=x2&py>=y1&py<=y2&&(console.log(" selected: "+j[t]),e.push(j[t]));return e}function s(e){var t=L.val(),n=i();if(n.length>0){var a="sendSelectionTo_"+t;payload={value:n,count:n.length,source:"PCA module"};var o={cmd:a,callback:"",status:"request",payload:payload};L.val(U),hub.send(JSON.stringify(o))}else alert("No selections to send...")}function l(e){if("success"==e.status){A=e.payload.scores,j=e.payload.ids,m(A);var t=(e.payload.importance,100*e.payload["importance.PC1"]),n=100*e.payload["importance.PC2"],a=$("#pcaTextDisplayDiv").html("");a.append("Proportion of Variance: "),a.append("PC1: "+t.toFixed(2)+"%, PC2: "+n.toFixed(2)+"%"),hub.raiseTab(J),c("pcaPlot: success")}else errorMessage=e.payload,$("<div/>").html(errorMessage).dialog({title:"pcaPlot error",width:600,height:300}),c("pcaPlot: error");q=!1}function c(e){$("#pcaStatusDiv").text(e)}function d(e){hub.raiseTab(J);var t=e.payload.value;console.log("=== Module.pca, highlightPatientIDs, candidates:"),console.log(JSON.stringify(t)),console.log("=== Module.pca, highlightPatientIDs, currentIdentifiers:"),console.log(JSON.stringify(j));var n=hub.intersectionOfArrays(t,j);if(console.log("=== Module.pca, highlightPatientIDs, intersection:"),console.log(JSON.stringify(n)),0==n.length){count=t.length,errorMessage="None of the incoming ids were recognized: ";for(var a=0;a<count;a++)errorMessage+=t[a]+" ";title="Unrecognized Identifiers",$("<div />").html(errorMessage).dialog({title:title,width:600,height:300})}else u(n,!0)}function u(e,t){console.log("=== module.pca: selectPoints"),console.log("    incoming ids count: "+e.length),d3.selectAll("circle").filter(function(t,n){return"undefined"==typeof t?!1:(match=e.indexOf(j[n]),match>=0)}).classed("highlighted",!0).transition().attr("r",7).duration(500)}function p(){d3.selectAll("circle").classed("highlighted",!1).attr("r",3),E.clear(),R.selectAll(".brush").call(E),r()}function g(){var e=F.val(),t={genes:e};null!==V&&(t.samples=V),msg={cmd:"calculatePCA",callback:"pcaPlot",status:"request",payload:t},hub.send(JSON.stringify(msg)),$("#pcaInstructions").css("display","none"),$("#pcaDisplay").css("display","block")}function h(e){if(console.log("Module.pca: handlePatientIDs"),"error"!==e.status){var t=F.val();e.payload.value;V=e.payload.value;var n={samples:V,genes:t};e={cmd:"calculatePCA",callback:"pcaPlot",status:"request",payload:n},hub.enableButton(z),hub.send(JSON.stringify(e))}else alert("Module.pca handlePatientIDs error: "+JSON.stringify(e))}function f(){O=E.extent(),console.log("region: "+O),x0=O[0][0],x1=O[1][0],width=Math.abs(x0-x1),console.log("width: "+width),width>.001&i().length>0?(console.log("enabling pcaSendSelectionMenu"),L.prop("disabled",!1)):(console.log("disabling pcaSendSelectionMenu"),L.prop("disabled",!0))}function v(e){return"black"}function m(e){var t=50,n=$("#pcaDisplay").width(),a=$("#pcaDisplay").height(),o=d3.max(e,function(e){return+e[0]}),r=d3.min(e,function(e){return+e[0]}),i=d3.max(e,function(e){return+e[1]}),s=d3.min(e,function(e){return+e[1]});o=1.1*o,r=1.1*r,i=1.1*i,s=1.1*s,N.select("#pcaSVG").remove();var l=d3.scale.linear().domain([r,o]).range([t,n-t]),c=d3.scale.linear().domain([s,i]).range([a-t,t]),d=l(0),u=c(0),p=d3.svg.axis().scale(l).orient("top").ticks(5),g=d3.svg.axis().scale(c).orient("left").ticks(5),h=N.append("div").attr("data-toggle","tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").text("a simple tooltip");E=d3.svg.brush().x(l).y(c).on("brushend",f),R=N.append("svg").attr("id","pcaSVG").attr("width",n).attr("height",a).call(E),R.append("g").attr("class","x axis").attr("transform","translate(0, "+u+")").call(p).append("text").style("font-size",14).text("PC1"),R.append("g").attr("class","y axis").attr("transform","translate("+d+", 0)").call(g).append("text").attr("y",10).attr("dy",".71em").style("font-size",14).style("text-anchor","end").text("PC2");R.append("g").selectAll("circle").data(e).enter().append("circle").attr("cx",function(e,t){return l(e[0])}).attr("cy",function(e,t){return c(e[1])}).attr("r",function(e){return 3}).style("fill",function(e){var t=v(e[0]);return""==t?"white":t}).style("stroke",function(e){var t=v(e[0]);return""==t?"black":t}).on("mouseover",function(e,t){return h.text(j[t]),h.style("visibility","visible")}).on("mousemove",function(){return h.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")}).on("mouseout",function(){return h.style("visibility","hidden")})}function y(e){console.log("=== datasetSpecified"),console.log(e);var t=e.payload.datasetName,n=e.payload.rownames,a=n.map(function(e){return e.indexOf("mtx.mrna")>=0?e:void 0});a=a.filter(function(e){return void 0!==e});var o=null;if(!(a.length>0))return alert("No mtx.mrna in dataset '"+t+"'"),void hub.disableButton(B);var r=a.length-1;o=a[r].replace(".RData",""),console.log("== calling createPcaObjectOnServer"),b(t,o),N.select("#pcaSVG").remove()}function b(e,t){console.log("create PCA on server "+e+": "+t),payload={dataPackage:e,matrixName:t},msg={cmd:"createPCA",callback:"pcaObjectCreated",status:"request",payload:payload},msg.json=JSON.stringify(msg),hub.send(msg.json)}function _(e){console.log("=== pcaObjectCreated"),console.log(e),"response"==e.status?t():alert("PCA module failed to create PCA object on server")}function w(e){if("success"!=e.status)return void alert("demoPCA failed: "+e.payload);var t=F.val();null==t&&(t="tcga.GBM.classifiers"),console.log("demoPCA, currentGeneSet: "+t),payload={ids:"",geneSet:t},e={cmd:"calculate_mRNA_PCA",callback:"pcaPlot",status:"request",payload:payload},hub.send(JSON.stringify(e))}function k(){var e=$("#datasetsDiv").length>0;return e?(G.css({display:"block"}),void S()):void alert("Datasets tab needed for QUnit testing")}function S(){QUnit.test("choose DEMOdz dataset",function(e){hub.raiseTab("datasetsDiv");var t="DEMOdz",n=$("#datasetMenu option").map(function(e){return this.value});if($.inArray(t,n)<0)return void alert("cannot run tests:  "+t+" dataset not loaded");$("#datasetMenu").val(t),$("#datasetMenu").trigger("change");var a=e.async(),o=e.async(),r=e.async();e.expect(3),setTimeout(function(){e.equal($("#datasetMenu").val(),t),a(),e.ok($("#datasetsManifestTable tr").length>=10),o(),e.equal($("#datasetsManifestTable tbody tr").eq(0).find("td").eq(0).text(),"mRNA expression"),r(),$("#selectDatasetButton").click(),hub.raiseTab(J),T()},5e3)})}function T(){hub.raiseTab(J),console.log("starting testCalculate"),QUnit.test("testPcaCalculate",function(e){$("#pcaCalculateButton").prop("disabled",!1),$("#pcaCalculateButton").css({"background-color":"red",color:"green"}),$("#pcaGeneSetSelector").val("random.24"),e.expect(1),setTimeout(function(){$("#pcaCalculateButton").click(),x()},6e3)})}function x(){console.log("--- testContentsOfPcaPlot"),QUnit.test("testPcaContents",function(e){e.expect(5);var t=e.async(),n=(e.async(),e.async()),a=e.async(),o=e.async();setTimeout(function(){e.ok($("circle").length>120),t();var r=$("circle")[0],i=Number(r.getAttribute("cx")),s=Number(r.getAttribute("cy")),l=Number(r.getAttribute("r"));console.log(i+"  "+s+"  "+l),e.ok(i>0),n(),e.ok(s>0),a(),e.equal(l,3),o()},5e3)})}function D(){var e={cmd:"getUserId",callback:"pcaAssessUserIdForTesting",status:"request",payload:""};hub.send(JSON.stringify(e))}function M(e){var t=e.payload;if(0===t.indexOf("autoTest")){console.log("plsr/Module.js running tests for user "+t);for(var n=0;3>n;n++)k()}}function C(){hub.addOnDocumentReadyFunction(e),hub.registerSelectionDestination(W,J),hub.addMessageHandler("datasetSpecified",y),hub.addMessageHandler("sendSelectionTo_PCA",h),hub.addMessageHandler("sendSelectionTo_PCA (highlight)",d),hub.addMessageHandler("pcaObjectCreated",_),hub.addMessageHandler("pcaHandleGeneSetNames",n),hub.addMessageHandler("pcaPlot",l),hub.addMessageHandler("demoPcaCalculateAndDraw",w),hub.addMessageHandler("pcaAssessUserIdForTesting",M),hub.addSocketConnectedFunction(D)}var A,O,I,N,E,R,P,G,L,H,B,z,F,V=null,q=!0,J="pcaDiv",j=[],U="Send selection...",W=["PCA","PCA (highlight)"];return demoPCAHighlight=function(){ids=["TCGA.06.0192","TCGA.12.0775","TCGA.14.0789"],u(ids,!0)},demo=function(){msg={cmd:"specifyCurrentDataset",callback:"pcaCurrentDataSetSpecified",status:"request",payload:"DEMOdz"},hub.send(JSON.stringify(msg))},{init:C,demo:demo}};pca=PCAModule(),pca.init();var plsrXXX,PLSRModule=function(){function e(){T=$("#plsrDisplay"),D=d3.select("#plsrDisplay"),M=$("#plsrStatusDiv"),A=$("#plsrAgeAtDxSlider"),O=$("#plsrAgeAtDxMinSliderReadout"),I=$("#plsrAgeAtDxMaxSliderReadout"),N=$("#plsrSurvivalSlider"),E=$("#plsrSurvivalMinSliderReadout"),R=$("#plsrSurvivalMaxSliderReadout"),B=$("#plsrCalculateButton"),B.button(),B.click(o),hub.disableButton(B),q=$("#plsrGeneSetSelector"),z=$("#plsrClearSelectionButton"),z.button(),z.click(g),hub.disableButton(z),C=hub.configureSendSelectionMenu("#plsrSendSelectionsMenu",oe,a,ae),J=$("#plsrTestingOutputDiv"),$(window).resize(d),d(),hub.disableTab(ne)}function t(e){if(q.empty(),0!==e.length){"string"==typeof e&&(e=[e]);for(var t=0;t<e.length;t++)optionMarkup="<option>"+e[t]+"</option>",q.append(optionMarkup)}}function n(e){console.log("=== Module.plsr, handleAgeAtDxAndSurvivalRanges"),"success"==e.status&&(K=Math.floor(e.payload.AgeDx[0]/365.24),Q=Math.floor(e.payload.AgeDx[4]/365.24),ee=Math.floor(e.payload.Survival[0]/365.24),te=Math.floor(e.payload.Survival[4]/365.24),r(),f())}function a(){var e=C.val();selectedIDs=u();var t="sendSelectionTo_"+e;payload={value:selectedIDs,count:selectedIDs.length,source:"plsr module"};var n={cmd:t,callback:"",status:"request",payload:payload};C.val(ae),hub.send(JSON.stringify(n))}function o(){P=365.24*Number(O.val()),G=365.24*Number(I.val()),L=365.24*Number(E.val()),H=365.24*Number(R.val());var e=q.val();factor1={name:"AgeDx",low:P,high:G},factor2={name:"Survival",low:L,high:H},payload={genes:e,factorCount:2,factors:[factor1,factor2]},msg={cmd:"calculatePLSR",callback:"handlePlsrResults",status:"request",payload:payload},msg.json=JSON.stringify(msg),hub.send(msg.json),$("#plsrInstructions").css("display","none"),$("#plsrDisplay").css("display","block")}function r(){var e=Q-K,t=te-ee;P=Math.floor(K+e/3),G=Math.floor(1+Q-e/3),L=Math.floor(ee+t/3),H=Math.floor(1+te-t/3),A.slider({range:!0,slide:function(e,t){return t.values[0]>t.values[1]?!1:(K=Number(t.values[0]),O.text(t.values[0]),Q=Number(t.values[1]),void I.text(t.values[1]))},min:K,max:Q,values:[P.toFixed(0),G.toFixed(0)]}),O.text(P),I.text(G),N.slider({range:!0,slide:function(e,t){return t.values[0]>t.values[1]?!1:(ee=t.values[0],E.text(ee),te=t.values[1],void R.text(te))},min:ee,max:te,values:[L,H]}),E.text(L),R.text(H)}function i(e){if(Y=!1,"error"==e.status)return void alert(e.payload);var t=e.payload,n=t.maxValue;Z=t.vectors,X=t.vectorNames,U=t.loadings,W=t.loadingNames,j=n,svg=c(U,W,Z,X,n),s("scatterplot complete")}function s(e){M.text(e)}function l(){V=F.extent(),x0=V[0][0],x1=V[1][0],width=Math.abs(x0-x1),selectedIDs=u(),console.log("=== plsr d3PlotBrushReader"),console.log("  selectedIDs: "+selectedIDs.length),console.log("   destinations: "+C.children().length)}function c(e,t,n,a,o){var r=70,i=T.width(),s=T.height();D.select("#plsrSVG").remove(),geneDataset=e,o=1.2*o;var c=-1*o,d=d3.scale.linear().domain([c,o]).range([r,i-2*r]),u=d3.scale.linear().domain([c,o]).range([s-r,r]);d3.svg.axis().scale(d).orient("bottom").ticks(5),d3.svg.axis().scale(u).orient("left").ticks(5);F=d3.svg.brush().x(d).y(u).on("brushend",l);var p=d3.scale.ordinal().domain(["gene","vector"]).range(["gray","red"]),g=D.append("svg").attr("id","plsrSVG").attr("width",i).attr("height",s).call(F),h=D.append("div").attr("data-toggle","tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").text("a simple tooltip");g.selectAll("circle").data(geneDataset).enter().append("circle").attr("cx",function(e,t){return d(e[0])}).attr("cy",function(e,t){return u(e[1])}).attr("r",function(e){return 3}).text(function(e,n){return t[n]}).style("fill",function(e){return p(e.category)}).on("mouseover",function(e,n){return h.text(t[n]),h.style("visibility","visible")}).on("mousemove",function(){return h.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")}).on("mouseout",function(){return h.style("visibility","hidden")}),g.selectAll("line").data(n).enter().append("line").attr("class","line").style("stroke-width",1).style("stroke","red").attr("x1",d(0)).attr("y1",u(0)).attr("x2",function(e){return d(e[0])}).attr("y2",function(e){return u(e[1])}),g.selectAll("text").data(n).enter().append("text").attr("class","text").attr("x",function(e){return d(e[0])}).attr("y",function(e){return u(e[1])}).text(function(e,t){return a[t]}).attr("text-anchor","middle").style("fill","black");return g}function d(){T.width(.95*$(window).width()),T.height(.75*$(window).height()),Y||c(U,W,Z,X,j)}function u(){x1=V[0][0],y1=V[0][1],x2=V[1][0],y2=V[1][1],ids=[];for(var e=0;e<U.length;e++)x=U[e][0],y=U[e][1],geneSymbol=W[e],x>=x1&x<=x2&y>=y1&y<=y2&&ids.push(geneSymbol);return ids}function p(e,t){d3.selectAll("circle").filter(function(t,n){return match=e.indexOf(W[n]),match>=0&&console.log("PLSR select match: "+W[n]),match>=0}).classed("highlighted",!0).transition().attr("r",20).style("fill","red").duration(500),hub.enableButton(z)}function g(){d3.selectAll("circle").classed("highlighted",!1).attr("r",3),F.clear(),svg.selectAll(".brush").call(F),d()}function h(e){hub.raiseTab(ne);var t=e.payload.value;console.log("PLSR highlight genes, candidates: "+t.length),console.log("                  currently held: "+W.length);var n=hub.intersectionOfArrays(t,W);if(console.log("                    intersection: "+n.length),console.log(JSON.stringify(n)),0===n.length){count=t.length,errorMessage="None of the incoming ids were recognized: ";for(var a=0;a<count;a++)errorMessage+=t[a]+" ";title="Unrecognized Identifiers",$("<div />").html(errorMessage).dialog({title:title,width:600,height:300})}else p(t,!0)}function f(){callback="plsrHandleGeneSetNames",msg={cmd:"getGeneSetNames",callback:callback,status:"request",payload:""},hub.send(JSON.stringify(msg))}function v(e){newNames=e.payload,t(newNames),hub.enableButton(B),hub.enableTab(ne),s("plsr ui now configured")}function m(e){console.log("==== Module.plsr, datasetSpecified"),console.log(e),plsrXXX=e;var t=e.payload.datasetName,n=e.payload.rownames,a=n.map(function(e){return e.indexOf("mtx.mrna")>=0?e:void 0});a=a.filter(function(e){return void 0!==e});var o=null;if(!(a.length>0))return void hub.disableButton(B);var r=a.length-1;o=a[r].replace(".RData",""),D.select("#plsrSVG").remove(),b(t,o)}function b(e,t){console.log("create PLSR on server "+e+": "+t),payload={dataPackage:e,matrixName:t},msg={cmd:"createPLSR",callback:"plsrObjectCreated",status:"request",payload:payload},msg.json=JSON.stringify(msg),hub.send(msg.json)}function _(e){console.log("--- requestSliderRanges"),console.log(e),e={cmd:"summarizePLSRPatientAttributes",callback:"handleAgeAtDxAndSurvivalRanges",status:"request",payload:["AgeDx","Survival"]},hub.send(JSON.stringify(e))}function w(){var e={cmd:"getUserId",callback:"plsrAssessUserIdForTesting",status:"request",payload:""};hub.send(JSON.stringify(e))}function k(e){var t=e.payload;if(0===t.indexOf("autoTest")){console.log("plsr/Module.js running tests for user "+t);var n=PlsrTestModule();n.run()}}function S(){hub.addOnDocumentReadyFunction(e),hub.registerSelectionDestination(oe,ne),hub.addMessageHandler("plsrHandleGeneSetNames",v),hub.addMessageHandler("handlePlsrResults",i),hub.addMessageHandler("handleAgeAtDxAndSurvivalRanges",n),hub.addMessageHandler("datasetSpecified",m),hub.addMessageHandler("sendSelectionTo_PLSR (highlight)",h),hub.addMessageHandler("plsrObjectCreated",_),hub.addMessageHandler("plsrAssessUserIdForTesting",k),hub.addSocketConnectedFunction(w)}var T,D,M,C,A,O,I,N,E,R,P,G,L,H,B,z,F,V,q,J,j,U=[],W=[],Z=[],X=[],Y=!0,K=0,Q=1e3,ee=0,te=1e3,ne="plsrDiv",ae="Send selection...",oe=["PLSR (highlight)"];return{init:S}};plsr=PLSRModule(),plsr.init();var OncoprintModule=function(){function e(){$(window).resize(t),l=hub.configureSendSelectionMenu("#oncoprintSendSelectionsMenu",h,n,g),$("#oncoprintControlsDiv").css("display","none"),$("#toggle_whitespace").click(function(){c.toggleCellPadding()});var e=1;$("#reduce_cell_width").click(function(){e*=.5,c.setZoom(e)}),t(),hub.disableTab(p)}function t(){m.width(.95*$(window).width()),y.width(m.width()),y.height("100px"),$("#onc").width(m.width()),m.height($("#onc").height()+100)}function n(e){var t=l.val(),n="sendSelectionTo_"+t,a=["dummy selection 1","dummy selection 2"];payload={value:a,count:a.length,source:u};var o={cmd:n,callback:"",status:"request",payload:payload};l.val(g),hub.send(JSON.stringify(o))}function a(e){hub.enableTab(p),hub.raiseTab(p);var t=e.payload.value;"string"==typeof t&&(t=[t]),console.log("Oncoprint module, "+e.cmd+" patients and markers: "+t),$("#onc").empty(),d=Date.now(),$("#oncoprintInstructions").css("display","none"),$("#oncoprintControlsDiv").css("display","block"),o(t)}function o(e){if($("#onc").append("Computing..."),console.log("Oncoprint module, hub.send 'oncoprint_data_selection' for %d IDs",e.length),e.length>450)alert("Please choose less than 450 Nodes");else{var t={sampleIDs:e},n={cmd:"oncoprint_data_selection",callback:"displayOncoprint",status:"request",payload:t};console.log("msg cmd, call back, status, payload: %s,%s,%s,%s",n.cmd,n.callback,n.status,n.payload.sampleIDs),hub.send(JSON.stringify(n))}}function r(e){if($("#onc").empty(),console.log("entering displayOncoprint"),console.log("displayOncoprint print recieved msg.payload: %s",e.payload),"error"==e.status)alert(e.payload),$("#onc").empty();else{xx=JSON.parse(e.payload),console.log("displayOncoprint print recieved genes: %s",xx[1]),genes=xx[1],processed_data=JSON.parse(xx[0]);var t=Date.now();c=Oncoprint.create("#onc",{cell_padding:f,cell_width:v}),console.log("Milliseconds to create Oncoprint div: ",Date.now()-t),c.suppressRendering();var n=Date.now();$.when(processed_data).then(function(){"string"==typeof genes&&(genes=[genes]),tracks_to_load=genes.length,console.log("Number of tracks to load: ",tracks_to_load);var e=[];for(i=0;i<genes.length;i++){Date.now();gene=genes[i];var t=processed_data.filter(function(e){return e.gene===gene}),a=Date.now();e[i]=c.addTrack({label:gene,removable:!0},0),console.log("Milliseconds to addTrack ",gene," : ",Date.now()-a),0==i?c.setRuleSet(e[i],Oncoprint.GENETIC_ALTERATION):c.useSameRuleSet(e[i],e[0]),c.setTrackData(e[i],t,!0)}c.releaseRendering(),c.sort(),console.log("Milliseconds to step through processded_data ",Date.now()-n)})}console.log("#######Computing since msg sent took: "+(Date.now()-d)+" milliseconds")}function s(e){console.log("--- Module.oncoprint, datasetSpecified: "+e.payload),hub.enableTab(p),$("#oncoprintInstructions").css("display","block"),$("#oncoprintControlsDiv").css("display","none"),$("#onc").empty()}var l,c,d,u="Oncoprint",p="oncoprintDiv",g="Send selection...",h=[u],f=3,v=4,m=$("#oncoprintDiv"),y=$("#oncoprintControlsDiv");return{init:function(){hub.registerSelectionDestination(h,p),hub.addOnDocumentReadyFunction(e),hub.addMessageHandler("datasetSpecified",s),hub.addMessageHandler("sendSelectionTo_Oncoprint",a),hub.addMessageHandler("displayOncoprint",r)}}};OncoprintM=OncoprintModule(),OncoprintM.init(),window.oncoprint_events={ADD_TRACK:"add_track.oncoprint",REMOVE_TRACK:"remove_track.oncoprint",MOVE_TRACK:"move_track.oncoprint",SORT:"sort.oncoprint",SET_CELL_PADDING:"set_cell_padding.oncoprint",SET_CELL_WIDTH:"set_cell_width.oncoprint",SET_TRACK_DATA:"set_track_data.oncoprint",SET_ID_ORDER:"set_id_order.oncoprint",CELL_CLICK:"cell_click.oncoprint",CELL_MOUSEENTER:"cell_mouseenter.oncoprint",CELL_MOUSELEAVE:"cell_mouseleave.oncoprint",ONCOPRINT_MOUSEENTER:"oncoprint_mouseenter.oncoprint",ONCOPRINT_MOUSELEAVE:"oncoprint_mouseleave.oncoprint",SET_PRE_TRACK_PADDING:"set_pre_track_padding.oncoprint",TRACK_INIT:"init.track.oncoprint",UPDATE_RENDER_RULES:"update_render_rules.cell_renderer.oncoprint",FINISHED_RENDERING:"finished_rendering.oncoprint",FINISHED_POSITIONING:"finished_positioning.renderer.oncoprint",SET_ZOOM:"set_zoom.oncoprint",SET_SORT_DIRECTION:"set_sort_direction.oncoprint",SET_VISIBLE_ID_ORDER:"set_visible_ids.oncoprint"},window.oncoprint_utils=function(){var e={};return e.sign=function(e){return e?0>e?-1:1:0},e.invert_array=function(e){return e.reduce(function(e,t,n){return e[t]=n,e},{})},e.cssClassToSelector=function(e){return"."+e.split(" ").join(".")},e.mouseY=function(t){return e.ifndef(t.offsetY,t.originalEvent&&t.originalEvent.layerY)},e.mouseX=function(t){return e.ifndef(t.offsetX,t.originalEvent&&t.originalEvent.layerX)},e.ifndef=function(e,t){return"undefined"==typeof e?t:e},e["extends"]=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e},e.makeIdCounter=function(){var e=0;return function(){return e+=1}},e.clamp=function(e,t,n){return Math.max(Math.min(n,e),t)},e.makeD3SVGElement=function(e){return d3.select(document.createElementNS("http://www.w3.org/2000/svg",e))},e.appendD3SVGElement=function(e,t,n){return t.select(function(){return this.appendChild(e.node().cloneNode(!0))})},e.spaceSVGElementsHorizontally=function(t,n){var a=0;e.d3SelectChildren(t,"*").each(function(){if("defs"!==this.tagName){var t=d3.select(this).attr("transform"),o=t&&t.indexOf("translate")>-1&&parseFloat(t.split(",")[1],10);o=o||0,d3.select(this).attr("transform",e.translate(a,o)),a+=this.getBBox().width,a+=n}});return t},e.textWidth=function(e,t){var n=$("<div>"+e+"</div>").css({position:"absolute","float":"left","white-space":"nowrap",visibility:"hidden",font:t}).appendTo($("body")),a=n.width();return n.remove(),a},e.d3SelectChildren=function(e,t){return e.selectAll(t).filter(function(){return this.parentNode===e.node()})},e.warn=function(e,t){console.log("Oncoprint error in "+t+": "+e)},e.stableSort=function(e,t){var n=[];_.each(e,function(e,t){n.push([e,t])});var a=function(e,n){var a=t(e[0],n[0]);return 0===a&&(e[1]<n[1]?a=-1:e[1]>n[1]&&(a=1)),a};return n.sort(a),_.map(n,function(e){return e[0]})},e.lin_interp=function(e,t,n){if("#"===t[0]){var a=[parseInt(t.substring(1,3),16),parseInt(n.substring(1,3),16)],o=[parseInt(t.substring(3,5),16),parseInt(n.substring(3,5),16)],n=[parseInt(t.substring(5,7),16),parseInt(n.substring(5,7),16)],r=Math.round(a[0]*(1-e)+a[1]*e).toString(16),i=Math.round(o[0]*(1-e)+o[1]*e).toString(16),s=Math.round(n[0]*(1-e)+n[1]*e).toString(16);return r=r.length<2?"0"+r:r,i=i.length<2?"0"+i:i,s=s.length<2?"0"+s:s,"#"+r+i+s}if(isNaN(t)&&t.indexOf("%")>-1){var l=parseFloat(t,10),s=parseFloat(n,10);return l*(1-e)+s*e+"%"}return t*(1-e)+n*e},e.translate=function(e,t){return"translate("+e+","+t+")"},e.assert=function(e,t){if(!e)throw t},e}(),window.oncoprint_defaults=function(){var e=window.oncoprint_utils,t=function(t){var n="cna",a=e.invert_array(["AMPLIFIED","HOMODELETED","GAINED","HEMIZYGOUSLYDELETED","DIPLOID",void 0]),o="mut_type",r=function(){if(t){var n=e.invert_array(["TRUNC","INFRAME","MISSENSE",void 0]);return function(e){return n[e]}}return function(e){return+("undefined"==typeof e)}}(),i="mrna",s="rppa",l=e.invert_array(["UPREGULATED","DOWNREGULATED",void 0]);return function(t,c){var d=e.sign(a[t[n]]-a[c[n]]);if(0!==d)return d;var u=e.sign(r(t[o])-r(c[o]));if(0!==u)return u;var p=e.sign(l[t[i]]-l[c[i]]);if(0!==p)return p;var g=e.sign(l[t[s]]-l[c[s]]);return 0!==g?g:0}},n={"default":[{shape:"full-rect",color:"#D3D3D3",z_index:-1}],altered:{cna:{AMPLIFIED:{shape:"full-rect",color:"red",legend_label:"Amplification"},GAINED:{shape:"full-rect",color:"#FFB6C1",legend_label:"Gain"},HOMODELETED:{shape:"full-rect",color:"#0000FF",legend_label:"Deep Deletion"},HEMIZYGOUSLYDELETED:{shape:"full-rect",color:"#8FD8D8",legend_label:"Shallow Deletion"}},mrna:{UPREGULATED:{shape:"outline",color:"#FF9999",legend_label:"mRNA Upregulation"},DOWNREGULATED:{shape:"outline",color:"#6699CC",legend_label:"mRNA Downregulation"}},rppa:{UPREGULATED:{shape:"small-up-arrow",color:"black",legend_label:"Protein Upregulation"},DOWNREGULATED:{shape:"small-down-arrow",color:"black",legend_label:"Protein Downregulation"}}},legend_label:"Genetic Alteration"},a=$.extend(!0,{},n);a.altered.mut_type={"*":{shape:"middle-rect",color:"green",legend_label:"Mutation"}};var o=$.extend(!0,{},n);return o.altered.mut_type={MISSENSE:{shape:"middle-rect",color:"green",legend_label:"Missense Mutation"},INFRAME:{shape:"middle-rect",color:"#9F8170",legend_label:"Inframe Mutation"},TRUNC:{shape:"middle-rect",color:"black",legend_label:"Truncating Mutation"},FUSION:{shape:"large-right-arrow",color:"black",legend_label:"Fusion"}},{genetic_alteration_config:o,genetic_alteration_config_nondistinct_mutations:a,genetic_alteration_comparator:t(!0),genetic_alteration_comparator_nondistinct_mutations:t(!1)}}(),window.oncoprint_RuleSet=function(){function e(e){y.call(this,e),this.type=c;var t=this,n=["#3366cc","#dc3912","#ff9900","#109618","#990099","#0099c6","#dd4477","#66aa00","#b82e2e","#316395","#994499","#22aa99","#aaaa11","#6633cc","#e67300","#8b0707","#651067","#329262","#5574a6","#3b3eac","#b77322","#16d620","#b91383","#f4359e","#9c5935","#a9c413","#2a778d","#668d1c","#bea413","#0c5922","#743411"],a=function(n,a){var o=s.makeD3SVGElement("rect").attr("fill",n),r=function(t){return function(n){return e.getCategory(n)===t}}(a);t.addStaticRule({condition:r,shape:o,legend_label:a})};e.color=e.color||{},_.each(e.color,function(e,t){a(e,t)}),t.addStaticRule(m(function(t){return"NA"===e.getCategory(t)},"NA")),this.sort_cmp=e.sort_cmp||function(t,n){var a=e.getCategory(t),o=e.getCategory(n);return"string"!=typeof a&&(a=a.toString()),"string"!=typeof o&&(o=o.toString()),a===o?0:"NA"===a?Number.POSITIVE_INFINITY:"NA"===o?Number.NEGATIVE_INFINITY:a.localeCompare(o);
},t.apply=function(t,o,r){return t.each(function(t,o){var r=e.getCategory(t);if(!e.color.hasOwnProperty(r)&&"NA"!==r){var i=n.pop();e.color[r]=i,a(i,r)}}),y.prototype.apply.call(this,t,o,r)},t.getLegendDiv=function(e,n,a){var o=d3.select(document.createElement("div"));return _.each(t.getRules(),function(t){if(e[t.rule_id]){var r=t.getLegendDiv(n,a);r&&o.node().appendChild(r)}}),s.d3SelectChildren(o,"*").style("padding-right","20px"),o.node()}}function t(e){y.call(this,e),this.type=d,this.data_key=e.data_key;var t=this.addGradientRule({shape:s.makeD3SVGElement("rect"),data_key:e.data_key,data_range:e.data_range,color_range:e.color_range,scale:e.scale,na_color:e.na_color});this.addStaticRule(m(function(t){return isNaN(t[e.data_key])},"NA")),this.sort_cmp=e.sort_cmp||$.proxy(v,this),this.getLegendDiv=function(e,n,a){return e[t]&&this.rule_map[t].getLegendDiv(n,a)||$("<div>")[0]}}function n(e){y.call(this,e);var t=this;t.type=p,t.data_key=e.data_key;var n=this.addBarChartRule({data_key:e.data_key,data_range:e.data_range,scale:e.scale,fill:e.fill,na_color:e.na_color});this.addStaticRule(m(function(t){return isNaN(t[e.data_key])},"NA")),this.sort_cmp=e.sort_cmp||$.proxy(v,this),this.getLegendDiv=function(e,t,a){return e[n]&&this.rule_map[n].getLegendDiv(t,a)||$("<div>")[0]}}function a(e){e=e&&e.dont_distinguish_mutation_color?$.extend({},e,l.genetic_alteration_config_nondistinct_mutations):$.extend({},e,l.genetic_alteration_config),e&&e.distinguish_mutation_order?this.sort_cmp=l.genetic_alteration_comparator:this.sort_cmp=l.genetic_alteration_comparator_nondistinct_mutations,y.call(this,e);var t=this;t.type=u;var n=function(e,n,a){var o,r,i,l,c="undefined"!=typeof n&&"undefined"!=typeof a?function(e,t){return t===h?function(t){return"undefined"!=typeof t[e]}:function(n){return n[e]===t}}(n,a):void 0;switch(e.shape){case"full-rect":o=s.makeD3SVGElement("rect"),r={fill:e.color,width:"100%",height:"100%"},i={},l=s.ifndef(e.z_index,0);break;case"middle-rect":o=s.makeD3SVGElement("rect"),r={fill:e.color,width:"100%",height:"33.33%",y:"33.33%"},i={},l=s.ifndef(e.z_index,1);break;case"large-right-arrow":o=s.makeD3SVGElement("polygon"),r={points:"0%,0% 100%,50% 0%,100%"},i={"stroke-width":"0px",fill:e.color},l=s.ifndef(e.z_index,2);break;case"small-up-arrow":o=s.makeD3SVGElement("polygon"),r={points:"50%,0% 100%,25% 0%,25%"},i={"stroke-width":"0px",fill:e.color},l=s.ifndef(e.z_index,3);break;case"small-down-arrow":o=s.makeD3SVGElement("polygon"),r={points:"50%,100% 100%,75% 0%,75%"},i={"stroke-width":"0px",fill:e.color},l=s.ifndef(e.z_index,4);break;case"outline":o=g,i={"outline-color":e.color,"outline-style":"solid","outline-width":"2px"},l=s.ifndef(e.z_index,5)}var d=t.addStaticRule({condition:c,shape:o,attrs:r,styles:i,z_index:l,legend_label:e.legend_label,exclude_from_legend:"undefined"==typeof e.legend_label});return d},a=[];_.each(e.altered,function(e,t){_.each(e,function(e,o){a.push(n(e,t,o))})}),_.each(e["default"],function(e){n(e)}),t.getLegendDiv=function(e,n,a){var o=d3.select(document.createElement("div"));return _.each(t.getRules(),function(t){if(e[t.rule_id]){var r=t.getLegendDiv(n,a);r&&o.node().appendChild(r)}}),s.d3SelectChildren(o,"*").style("padding-right","20px"),o.node()},t.alteredData=function(e){var n=[];return _.each(a,function(a){n=n.concat(t.getRule(a).filterData(e))}),_.uniq(n)}}function o(e,t){b.call(this,e,t),this.data_key=e.data_key,this.data_range=e.data_range,this.inferred_data_range,this.attrs.fill=function(t){return isNaN(t[e.data_key])?e.na_color:e.fill},this.na_color=e.na_color;var n=function(t){return"log"===e.scale?Math.log10(Math.max(Math.abs(t),.1)):t},a=function(t){var n={};return n[e.data_key]=t,n};this.setUpHelperFunctions=function(t){var a=_.map(t,n),o=function(t){var o=n(t[e.data_key]),r=Math.abs(o-a[0])/Math.abs(a[1]-a[0]);return 100*r},r=function(t){return(isNaN(t[e.data_key])?"0":100-o(t))+"%"},i=function(t){return(isNaN(t[e.data_key])?"100":o(t))+"%"};this.attrs.height=i,this.attrs.y=r},this.inferDataRange=function(e){var t=this,n=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;return e.each(function(e,o){var r=e[t.data_key],i=isNaN(r);n=Math.min(n,i?Number.POSITIVE_INFINITY:r),a=Math.max(a,i?Number.NEGATIVE_INFINITY:r)}),[n,a]},this.getEffectiveDataRange=function(){if("undefined"==typeof this.data_range)return this.inferred_data_range;var e=[];return e[0]="undefined"==typeof this.data_range[0]?this.inferred_data_range[0]:this.data_range[0],e[1]="undefined"==typeof this.data_range[1]?this.inferred_data_range[1]:this.data_range[1],e},this.getLegendDiv=function(t,n){if(this.showInLegend()){var o=d3.select(document.createElement("div")),r=this.getEffectiveDataRange();if(!r)return o.node();var i=_.map(r,function(t){var n=Math.pow(10,s.ifndef(e.legend_num_decimal_digits,2));return Math.round(t*n)/n});o.append("span").text(i[0]).classed("oncoprint-legend-label oncoprint-legend-element",!0).style("position","relative").style("bottom","0px");for(var l=50,c=o.append("svg").attr("width",l+"px").attr("height",n+"px").classed("oncoprint-legend-element",!0),d=0;l>=d;d++){var u=d/l,p=(1-u)*r[0]+u*r[1],g=a(p),h=n*parseInt(this.attrs.height(g))/100;c.append("rect").attr("width","1px").attr("height",h+"px").attr("y",n-h+"px").attr("fill",e.fill).attr("x",d+"px")}return o.append("span").text(i[1]).classed("oncoprint-legend-label oncoprint-legend-element",!0).style("position","relative").style("bottom",n-3+"px"),s.d3SelectChildren(o,"*").style("padding-right","10px"),o.node()}},this.apply=function(e,t,n){0!==e[0].length&&(this.inferred_data_range=this.inferDataRange(e),this.setUpHelperFunctions(this.getEffectiveDataRange()),b.prototype.apply.call(this,e,t,n))}}function r(e,t){b.call(this,e,t),this.data_key=e.data_key,this.data_range=e.data_range,this.inferred_data_range,this.color_range=e.color_range,this.na_color=e.na_color;var n=function(t){var n={};return n[e.data_key]=t,n},a=function(t){return"log"===e.scale?Math.log10(Math.max(t,.1)):t};this.setUpHelperFunctions=function(t){var n=_.map(t,a),o=function(t){if(isNaN(t[e.data_key]))return e.na_color;var o=a(t[e.data_key]),r=([n[0],n[1]],(o-n[0])/(n[1]-n[0]));return color_range=[d3.rgb(e.color_range[0]).toString(),d3.rgb(e.color_range[1]).toString()],s.lin_interp(r,e.color_range[0],e.color_range[1])};this.attrs.fill=o},this.inferDataRange=function(e){var t=this,n=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;return e.each(function(e,o){var r=e[t.data_key],i=isNaN(r);n=Math.min(n,i?Number.POSITIVE_INFINITY:r),a=Math.max(a,i?Number.NEGATIVE_INFINITY:r)}),[n,a]},this.getLegendDiv=function(t,a){if(this.showInLegend()){var o=d3.select(document.createElement("div")),r=this.data_range||this.inferred_data_range;if(!r)return o.node();var i=_.map(r,function(t){var n=Math.pow(10,s.ifndef(e.legend_num_decimal_digits,2));return Math.round(t*n)/n});o.append("span").text(i[0]).classed("oncoprint-legend-label oncoprint-legend-element",!0).style("position","relative").style("bottom",a/2-3+"px");for(var l=50,c=o.append("svg").attr("width",l+"px").attr("height",a+"px").classed("oncoprint-legend-element",!0),d=0;l>=d;d++){var u=d/l,p=(1-u)*r[0]+u*r[1],g=n(p);c.append("rect").attr("width","1px").attr("height",a+"px").attr("fill",this.attrs.fill(g)).attr("x",d+"px")}return o.append("span").text(i[1]).classed("oncoprint-legend-label oncoprint-legend-element",!0).style("position","relative").style("bottom",a/2-3+"px"),s.d3SelectChildren(o,"*").style("padding-right","10px"),o.node()}},this.apply=function(e,t,n){this.setUpHelperFunctions(this.data_range||(this.inferred_data_range=this.inferDataRange(e))),b.prototype.apply.call(this,e,t,n)}}function i(e,t){b.call(this,e,t),this.getLegendDiv=function(e,t){if(this.showInLegend()){var n=d3.select(document.createElement("div")),a=n.append("div").classed("oncoprint-legend-block",!0),o=a.append("svg").attr("width",e+"px").attr("height",t+"px").classed("oncoprint-legend-element",!0);return this.apply(o,e,t),this.legend_label&&n.append("span").text(this.legend_label).classed("oncoprint-legend-label oncoprint-legend-element",!0).style("position","relative").style("bottom",t/2-3+"px"),s.d3SelectChildren(n,"*").style("padding-right","10px"),n.node()}}}var s=oncoprint_utils,l=oncoprint_defaults,c="categorical_color",d="gradient_color",u="genetic_alteration",p="bar_chart",g="cell",h="*",f=s.makeIdCounter(),v=function(e,t){var n=parseFloat(e[this.data_key],10),a=parseFloat(t[this.data_key],10),o=isNaN(n),r=isNaN(a);return o&&r?0:o||r?o?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:a>n?-1:n>a?1:0},m=function(e,t){return{condition:e,shape:s.makeD3SVGElement("rect"),attrs:{fill:"#eeeeee",width:"100%",height:"100%"},legend_label:t,children:[{condition:e,shape:s.makeD3SVGElement("path"),attrs:{d:"m 0% 0% L 100% 100%"},styles:{"stroke-width":"1px",stroke:"#555555"},legend_label:t}]}},y=function(){function e(e){this.rule_map={},this.rule_set_id=f(),this.legend_label=e.legend_label,this.exclude_from_legend=!1}var t=s.makeIdCounter();return e.prototype.getLegendLabel=function(){return this.legend_label},e.prototype.getRuleSetId=function(){return this.rule_set_id},e.prototype.addRule=function(e){var n=t();return this.rule_map[n]=new b(e,n),n},e.prototype.addStaticRule=function(e){var n=t();return this.rule_map[n]=new i(e,n),n},e.prototype.addGradientRule=function(e){var n=t();return this.rule_map[n]=new r(e,n),n},e.prototype.addBarChartRule=function(e){var n=t();return this.rule_map[n]=new o(e,n),n},e.prototype.removeRule=function(e){delete this.rule_map[e]},e.prototype.getRules=function(){var e=this,t=Object.keys(this.rule_map),n=_.map(t,function(t){return e.rule_map[t]}),a=_.sortBy(n,function(e){return e.z_index});return a},e.prototype.apply=function(e,t,n){var a={};return _.each(this.getRules(),function(o){var r=o.filter(e);r[0].length>0&&(a[o.rule_id]=!0),o.apply(r,t,n)}),a},e.prototype.getRule=function(e){return this.rule_map[e]},e}();e.prototype=Object.create(y.prototype),t.prototype=Object.create(y.prototype),n.prototype=Object.create(y.prototype),a.prototype=Object.create(y.prototype);var b=function(){function e(t,n){this.rule_id=n,this.condition=t.condition||function(e){return!0},this.shape="undefined"==typeof t.shape?s.makeD3SVGElement("rect"):t.shape,this.z_index="undefined"==typeof t.z_index?this.rule_id:t.z_index,this.legend_label=t.legend_label,this.exclude_from_legend=t.exclude_from_legend,this.attrs=t.attrs||{},this.attrs.width=s.ifndef(this.attrs.width,"100%"),this.attrs.height=s.ifndef(this.attrs.height,"100%"),this.attrs.x=s.ifndef(this.attrs.x,0),this.attrs.y=s.ifndef(this.attrs.y,0),this.styles=t.styles||{},this.children=_.map(t.children,function(t){return new e(t)})}var t=function(e,t,n,a){var o=["width","x"],r=["height","y"];return e=parseFloat(e,10)/100,o.indexOf(t)>-1?e*=n:r.indexOf(t)>-1&&(e*=a),e+""},n=function(e,n,a,o,r,i){var s=a;if("function"==typeof s&&(s=s(e,n)),"string"==typeof s&&s.indexOf("%")>-1)if("points"===o)s=_.map(s.split(" "),function(e){var n=e.split(","),a=t(n[0],"x",r,i),o=t(n[1],"y",r,i);return a+","+o}).join(" ");else{if("d"===o){for(var l=s.split(/\s+/),n=0,c=l.length;c>n;n++){var d=l[n].toLowerCase();("m"===d||"l"===d)&&(l[n+1]=t(l[n+1],"x",r,i),l[n+2]=t(l[n+2],"y",r,i),n+=2)}return l.join(" ")}s=t(s,o,r,i)}return s};return e.prototype.apply=function(e,t,a){var o=this.shape,r=o===g?e:s.appendD3SVGElement(o,e),i=this.styles,l=this.attrs;l.x=l.x||0,l.y=l.y||0,_.each(l,function(e,o){r.attr(o,function(r,i){return n(r,i,e,o,t,a)})}),_.each(i,function(e,t){r.style(t,e)}),_.each(this.children,function(n){n.apply(e,t,a)})},e.prototype.filter=function(e){return e.filter(this.condition)},e.prototype.filterData=function(e){return e.filter(this.condition)},e.prototype.showInLegend=function(){return!this.exclude_from_legend},e}();return o.prototype=Object.create(b.prototype),r.prototype=Object.create(b.prototype),i.prototype=Object.create(b.prototype),{CATEGORICAL_COLOR:c,GRADIENT_COLOR:d,GENETIC_ALTERATION:u,BAR_CHART:p,makeRuleSet:function(o,r){return o===c?new e(r):o===d?new t(r):o===u?new a(r):o===p?new n(r):new y}}}(),window.OncoprintRenderer=function(){function e(e,n){this.rule_sets={},this.clipping=!0,this.oncoprint=e,this.config=n,this.upper_padding=t.ifndef(n.upper_padding,0),this.max_label_length=t.ifndef(n.max_label_length,20),this.track_group_separation=12,function(e){var n=e.getLabelFont(),a=t.textWidth((Math.pow(10,e.max_label_length)-1).toString(),n),o=t.textWidth("100%",n),r=20;e.label_area_width=a+r+o}(this)}var t=(oncoprint_events,oncoprint_utils),n=oncoprint_RuleSet;return e.prototype.getCellCSSClass=function(){return"oncoprint-cell"},e.prototype.getTrackCellCSSClass=function(e){return this.getCellCSSClass()+e},e.prototype.getTrackLabelCSSClass=function(e){return"oncoprint-track-label oncoprint-track-label"+e},e.prototype.getTrackLabelCSSSelector=function(e){return"."+this.getTrackLabelCSSClass(e).split(" ").join(".")},e.prototype.getTrackCellCtrCSSClass=function(e){return"oncoprint-track-cell-ctr"+e},e.prototype.getLabelFont=function(){return this.config.label_font},e.prototype.setRuleSet=function(e,t,a){var o=n.makeRuleSet(t,a);this.rule_sets[e]=o,o.sort_cmp&&this.oncoprint.setTrackSortComparator(e,o.sort_cmp)},e.prototype.useSameRuleSet=function(e,t){var n=this.rule_sets[t];this.rule_sets[e]=n,n.sort_cmp&&this.oncoprint.setTrackSortComparator(e,n.sort_cmp)},e.prototype.getRuleSet=function(e){return this.rule_sets[e]},e.prototype.getTrackTops=function(){var e={},t=this.upper_padding,n=this;return _.each(this.oncoprint.getTrackGroups(),function(a){0!==a.length&&(_.each(a,function(a){e[a]=t,t+=n.getRenderedTrackHeight(a)}),t+=n.track_group_separation)}),e},e.prototype.getTrackCellTops=function(){return this.track_cell_tops||this.computeTrackCellTops()},e.prototype.computeTrackCellTops=function(){var e=this.getTrackTops(),t=this;return _.each(e,function(n,a){e[a]=n+t.oncoprint.getTrackPadding(a)}),this.track_cell_tops=e,e},e.prototype.getTrackLabelTops=function(){return this.getTrackCellTops()},e.prototype.getRenderedTrackHeight=function(e){return this.oncoprint.getTrackHeight(e)+2*this.oncoprint.getTrackPadding(e)},e.prototype.getCellX=function(e){return"number"==typeof e?e*(this.oncoprint.getZoomedCellWidth()+this.oncoprint.getCellPadding()):-1},e.prototype.getCellXArray=function(e){var t=this.oncoprint.getZoomedCellWidth()+this.oncoprint.getCellPadding();return _.map(_.range(0,e),function(e){return e*t})},e.prototype.getCellAreaWidth=function(){return this.oncoprint.getVisibleIdOrder().length*(this.oncoprint.getZoomedCellWidth()+this.oncoprint.getCellPadding())},e.prototype.getCellAreaHeight=function(){var e=this.getTrackTops(),t=this.oncoprint.getTracks();if(0===t.length)return 0;var n=t[t.length-1];return e[n]+this.getRenderedTrackHeight(n)},e.prototype.getLabelAreaWidth=function(){return this.label_area_width},e.prototype.getLabelAreaHeight=function(){return this.getCellAreaHeight()},e.prototype.render=function(){throw"not implemented in abstract class"},e}(),window.OncoprintSVGRenderer=function(){function e(e,s,c){OncoprintRenderer.call(this,s,c);var d=this;this.track_cell_selections={},this.track_cells={},this.active_rule_set_rules={},this.toolbar_container,this.label_div,this.label_drag_div,this.label_container,this.cell_container,this.cell_container_node,this.cell_div,this.legend_table,this.document_fragment,this.percent_altered_max_width=n.textWidth("100%",d.getLabelFont()),this.altered_data_percentage={},this.cell_tooltip_html="",this.container=d3.select(e),this.container.classed("noselect",!0).selectAll("*").remove(),this.container.append("br"),function(){c.legend&&(d.legend_table=d3.select(e).append("table").style("border-collapse","collapse"))}();var u=d3.select(e).append("div").classed("oncoprint-content-area",!0);!function(){d.label_container=u.append("div").classed(a,!0).style("position","relative"),d.label_div=d.label_container.append("div").style("position","relative").style("overflow","hidden"),d.label_drag_div=d.label_container.append("div").style("position","absolute").style("overflow","hidden").style("top","0px").style("left","0px").style("display","none")}(),function(){d.cell_container=u.append("div").classed(o,!0),d.cell_column_highlight=d.cell_container.append("div").classed(i,!0).style("height",d.getCellAreaHeight()).style("visibility","hidden"),d.cell_container_node=d.cell_container.node(),d.cell_div=d.cell_container.append("div").classed(r,!0),d.cell_mouseover_div=d.cell_container.append("div").style("position","absolute").style("overflow","hidden").style("top","0px").style("left","0px"),d.cell_container_node.addEventListener("scroll",function(){d.calculateVisibleInterval(),d.clipAndPositionCells()});var e,t;!function(){var a,o,r,i,c=[];$(d.cell_div.node()).qtip({content:"SHARED QTIP",position:{target:"event",my:"bottom middle",at:"top middle",viewport:$(window)},style:{classes:l,border:"none"},show:{event:"cell-mouseover"},hide:{fixed:!0,delay:100,event:"cell-mouseout"},events:{show:function(){$(this).find(".qtip-content").html(d.cell_tooltip_html)},render:function(){$(this).find(".qtip-content").html(d.cell_tooltip_html)}}});var u=function(e){$("."+l).finish(),$(e).trigger("cell-mouseover")},p=function(e){$("."+l).finish(),$(e).trigger("cell-mouseout")},g=function(){a=void 0,o=void 0,r&&p(r),r=void 0,i&&clearTimeout(i),_.each(c,function(e){e&&(e.style.border="",e.style.margin="")}),c=[]};t=function(){g()},e=function(e){var t=n.mouseX(e),p=n.mouseY(e),h=d.getTrackCellTops(),f=function(){var e=Number.POSITIVE_INFINITY,t=void 0;return _.each(h,function(n,a){var o=p-n;o>=0&&e>o&&(e=o,t=a)}),t}();if(!f)return void g();var v=s.getCellHeight(f);if(p>h[f]+v)return void g();var m=s.getZoomedCellWidth(),y=m+s.getCellPadding();if(t%y>m)return void g();var b=Math.floor(t/y);if(b!==o||f!==a){i&&clearTimeout(i),g();var w=s.getVisibleIdOrder()[b],k=d.track_cells[f][w];if(!k)return;$("."+l).finish().hide(),o=b,a=f,r=k.dom,d.cell_tooltip_html=s.getTrackTooltip(f)(k.d),u(r),i=setTimeout(function(){c=_.map(d.track_cells,function(e,t){var n=e[w].dom;return n&&(t===f?(n.style.border="1px solid #000000",n.style.margin="-1px"):(n.style.border="1px solid #999999",n.style.margin="-1px")),n})},200)}}}(),d.cell_mouseover_div.node().addEventListener("mousemove",e),d.cell_mouseover_div.node().addEventListener("mouseout",t),d.cell_div.style("max-width","1000px")}(),$(u.node()).hover(function(){$(d.label_div.node()).find("."+d.getTrackButtonCSSClass()).stop().fadeTo(80,1)},function(){$(d.label_div.node()).find("."+d.getTrackButtonCSSClass()).stop().fadeOut(500)}),function(){$(s).on(t.REMOVE_TRACK,function(e,t){var n=t.track_id;delete d.rule_sets[n],delete d.track_cell_selections[n],delete d.altered_data_percentage[n],d.removeTrackCells(n),d.removeTrackLabels(n),d.removeTrackButtons(n),d.computeTrackCellTops(),d.renderLegend(),d.renderTrackLabels(),d.renderTrackButtons(),d.resizeLabelDiv(),d.resizeCellDiv(),s.sort()}),$(s).on(t.MOVE_TRACK,function(e,t){d.computeTrackCellTops(),d.clipAndPositionCells(t.moved_tracks,"top",!0),d.renderTrackLabels(),d.renderTrackButtons(),s.sort()}),$(s).on(t.ADD_TRACK,function(e,t){d.drawCells(t.track_id),d.clipAndPositionCells(void 0,"top",!0),d.computeTrackCellTops(),d.renderTrackLabels(),d.renderTrackButtons(),d.resizeLabelDiv()}),$(s).on(t.SET_TRACK_DATA,function(e,t){d.drawCells(t.track_id),d.clipAndPositionCells(t.track_id,void 0,!0),d.computeAlteredDataPercentage(t.track_id),d.renderTrackLabels(t.track_id),d.resizeCellDiv(),d.renderLegend()}),$(s).on(t.SET_CELL_PADDING,function(e,t){d.clipAndPositionCells(void 0,void 0,!0),d.resizeCellDiv()}),$(s).on(t.SET_ZOOM,function(e,t){d.clipAndPositionCells(void 0,void 0,!0),d.resizeCells(),d.resizeCellDiv()}),$(s).on(t.SET_VISIBLE_ID_ORDER,function(){d.clipAndPositionCells(void 0,void 0,!0),d.resizeCellDiv()})}()}var t=oncoprint_events,n=oncoprint_utils,a="oncoprint-label-area-ctr",o="oncoprint-cell-area-ctr",r="oncoprint-cell-area",i="oncoprint-column-highlight",s="oncoprint-label-dragging",l="oncoprint-cell-qtip";return n["extends"](e,OncoprintRenderer),e.prototype.computeAlteredDataPercentage=function(e){var t=this.getRuleSet(e);if(t&&t.alteredData){var n=this.oncoprint.getTrackData(e),a=t.alteredData(n).length,o=Math.floor(100*a/n.length);this.altered_data_percentage[e]=o}},e.prototype.getAlteredDataPercentage=function(e){return this.altered_data_percentage[e]},e.prototype.calculateVisibleInterval=function(){var e=(this.oncoprint.getZoomedCellWidth()+this.oncoprint.getCellPadding(),this.cell_container_node.getBoundingClientRect());return this.visible_interval=[this.cell_container_node.scrollLeft,this.cell_container_node.scrollLeft+e.right-e.left],this.visible_interval},e.prototype.getVisibleInterval=function(){return this.visible_interval||this.calculateVisibleInterval()},e.prototype.cellRenderTarget=function(){return d3.select(this.document_fragment||this.cell_div.node())},e.prototype.suppressRendering=function(){this.document_fragment=document.createDocumentFragment()},e.prototype.releaseRendering=function(){this.cell_div.node().appendChild(this.document_fragment),this.document_fragment=void 0;var e=this;$(this.cell_div.node()).ready(function(){e.resizeCells(),e.clipAndPositionCells(void 0,void 0,!0)})},e.prototype.setRuleSet=function(e,t,n){OncoprintRenderer.prototype.setRuleSet.call(this,e,t,n),this.active_rule_set_rules[this.getRuleSet(e).getRuleSetId()]={},this.drawCells(e),this.clipAndPositionCells(e,void 0,!0),this.renderLegend(),this.computeAlteredDataPercentage(e),this.renderTrackLabels(e)},e.prototype.useSameRuleSet=function(e,t){OncoprintRenderer.prototype.useSameRuleSet.call(this,e,t),this.drawCells(e),this.clipAndPositionCells(e,void 0,!0),this.renderLegend(),this.computeAlteredDataPercentage(e),this.renderTrackLabels(e)},e.prototype.getLabelDiv=function(){return this.label_div},e.prototype.getLabelDragDiv=function(){return this.label_drag_div},e.prototype.resizeCellDiv=function(){this.cell_div.style("min-width",this.getCellAreaWidth()+"px").style("min-height",this.getCellAreaHeight()+"px"),this.cell_mouseover_div.style("min-width",this.getCellAreaWidth()+"px").style("min-height",this.getCellAreaHeight()+"px"),this.cell_column_highlight.style("height",this.getCellAreaHeight()+"px")},e.prototype.resizeLabelDiv=function(){this.getLabelDiv().style("width",this.getLabelAreaWidth()+"px").style("height",this.getLabelAreaHeight()+"px"),this.getLabelDragDiv().style("width",this.getLabelAreaWidth()+"px").style("height",this.getLabelAreaHeight()+"px")},e.prototype.removeTrackLabels=function(e){e="undefined"==typeof e?this.oncoprint.getTracks():e,e=[].concat(e);var t=this.label_div,n=this;_.each(e,function(e){t.selectAll(n.getTrackLabelCSSSelector(e)).remove()})},e.prototype.renderTrackLabels=function(e,t,n){var a=this.label_div;if("undefined"!=typeof t)a.selectAll(this.getTrackLabelCSSSelector(e)).style("top",t+"px");else{e="undefined"==typeof e?this.oncoprint.getTracks():e,e=[].concat(e);var o=this.getTrackLabelTops(),r=this,i=this.getLabelAreaWidth(),s=i-this.percent_altered_max_width;_.each(e,function(e){var t=o[e],i=(r.getTrackLabelCSSClass(e),r.oncoprint.getTrackLabel(e)),l=i;i.length>r.max_label_length&&!n&&(l=i.substring(0,r.max_label_length-3)+"..."),_.each(a.selectAll(r.getTrackLabelCSSSelector(e)),function(e){$(e).qtip("destroy")}),a.selectAll(r.getTrackLabelCSSSelector(e)).remove();var c=a.append("span").style("position","absolute").classed(r.getTrackLabelCSSClass(e),!0).classed("oncoprint-track-label-draggable",!0).classed("oncoprint-track-label-main",!0).classed("oncoprint-track-label",!0).classed("noselect",!0).style("font-family",r.getLabelFont()).style("font-weight","bold").text(l).style("top",t+"px").on("mousedown",function(){r.dragLabel(e)});$(c.node()).qtip({content:{text:i.length>r.max_label_length?i+"<br> hold to drag":"hold to drag"},position:{my:"middle right",at:"middle left",viewport:$(window)},style:{classes:"qtip-light qtip-rounded qtip-shadow qtip-lightyellow"},show:{event:"mouseover"}});var d=r.getAlteredDataPercentage(e);"undefined"!=typeof d&&a.append("span").style("position","absolute").classed(r.getTrackLabelCSSClass(e),!0).classed("oncoprint-track-label",!0).classed("noselect",!0).style("font-family",r.getLabelFont()).text(d+"%").style("top",t+"px").style("left",s+"px")})}},e.prototype.getTrackButtonCSSClass=function(e){return"oncoprint-track-button"+n.ifndef(e,"")},e.prototype.removeTrackButtons=function(e){var t=this.label_div;e="undefined"==typeof e?this.oncoprint.getTracks():e,e=[].concat(e);var n=this;_.each(e,function(e){t.selectAll("."+n.getTrackButtonCSSClass(e)).remove()})},e.prototype.renderTrackButtons=function(e){var t=this.label_div;e="undefined"==typeof e?this.oncoprint.getTracks():e,e=[].concat(e);var n=this.getTrackLabelTops(),a=this,o=this.getLabelAreaWidth();_.each(e,function(e){var r=a.getTrackButtonCSSClass(e);t.selectAll("."+r).remove();var i=o-15;a.oncoprint.isTrackRemovable(e)&&(!function(){var o=t.append("span").classed("noselect",!0).style("font-size","12px").style("color","#87CEFA").style("cursor","pointer").classed(r,!0).classed(a.getTrackButtonCSSClass(),!0).on("click",function(){a.oncoprint.removeTrack(e)}).style("position","absolute").style("left",i+"px").style("top",n[e]+"px");o.text("X"),$(o.node()).hover(function(){o.style("font-size","15px").style("color","#0000FF")},function(){o.style("font-size","12px").style("color","#87CEFA")}).qtip({content:{text:"Click to remove"},position:{my:"bottom middle",at:"top middle",viewport:$(window)},style:{classes:"qtip-light qtip-rounded qtip-shadow qtip-lightyellow"},show:{event:"mouseover"},hide:{fixed:!0,delay:100,event:"mouseout"}})}(),i-=35),a.oncoprint.isTrackSortDirectionChangable(e)&&!function(){var o=["images/decreaseSort.svg","images/increaseSort.svg","images/nonSort.svg"],s=["Click to sort in descending order","Click to not sort on this track","Click to sort in ascending order"],l=[1,-1,0],c=l.indexOf(a.oncoprint.getTrackSortDirection(e)),d=t.append("img");d.attr("src",o[c]).style("cursor","pointer"),$(d.node()).qtip({content:{text:function(){return s[c]}},position:{my:"bottom middle",at:"top middle",viewport:$(window)},style:{classes:"qtip-light qtip-rounded qtip-shadow qtip-lightyellow"},show:{event:"mouseover"},hide:{fixed:!0,delay:100,event:"mouseout"}}),d.classed(r,!0).classed(a.getTrackButtonCSSClass(),!0).on("click",function(){c=(c+1)%3,a.oncoprint.setTrackSortDirection(e,l[c]),d.attr("src",o[c])}).style("position","absolute").style("left",i+"px").style("top",n[e]+"px")}()})},e.prototype.resizeCells=function(e){this.cell_div.selectAll("svg."+this.getCellCSSClass()).style("width",this.oncoprint.getZoomedCellWidth()+"px")},e.prototype.removeTrackCells=function(e){this.cell_div.selectAll("svg."+this.getTrackCellCSSClass(e)).remove()},e.prototype.drawTrackCells=function(e,t){var n=this.oncoprint,a=n.getTrackData(e),o=(n.getTrackDatumIdKey(e),n.getTrackDatumIdAccessor(e)),r=this.getRuleSet(e);if(r){var i=this;this.track_cells[e]={};var s=this.getCellCSSClass(),l=this.getTrackCellCSSClass(e),c=this.track_cells[e],d=d3.select(t).selectAll("svg."+l).data(a);d.enter().append("svg").classed(l,!0).classed(s,!0).attr("shape-rendering","geometricPrecision").attr("preserveAspectRatio","none").attr("viewBox","0 0 "+n.getFullCellWidth()+" "+n.getCellHeight(e)).style("width",n.getZoomedCellWidth()+"px").style("height",n.getCellHeight(e)+"px"),d.exit().remove();n.getTrackTooltip(e);d.each(function(e,t){var n=o(e);c[n]={dom:this,d:e}}),d.selectAll("*").remove(),this.active_rule_set_rules[r.getRuleSetId()][e]=r.apply(d,n.getFullCellWidth(),n.getCellHeight(e)),i.track_cell_selections[e]=d}},e.prototype.drawCells=function(e){var n;n=this.document_fragment?document.createDocumentFragment():this.cell_div.node(),e="undefined"==typeof e?this.oncoprint.getTracks():e,e=[].concat(e);var a=this;_.each(e,function(e){a.drawTrackCells(e,n)}),this.document_fragment&&this.cellRenderTarget().node().appendChild(n),setTimeout(function(){$(a).trigger(t.FINISHED_RENDERING)},0)},e.prototype.clipAndPositionCells=function(e,t,n,a){this.cell_div.node().display="none",e="undefined"==typeof e?this.oncoprint.getTracks():e,e=[].concat(e);var o=this.getVisibleInterval(),r=4*(o[1]-o[0]),i=Math.floor(o[0]/r);o=_.map([-r,2*r],function(e){return Math.max(e+i*r,0)});var s=this,l=this.getTrackCellTops(),c=this.oncoprint.getVisibleInvertedIdOrder(),d=this.getCellXArray(Object.keys(c).length);_.each(e,function(e){var r;t&&"top"!==t||(r=l[e]);var u=s.oncoprint.getTrackDatumIdKey(e);(i!==s.prev_interval_number||n)&&s.track_cell_selections.hasOwnProperty(e)&&s.track_cell_selections[e].each(function(e,n){var i=d[c[e[u]]],s=this.style.display,l=(isNaN(i)||i<o[0]||i>o[1])&&!a?"none":"inherit";s!==l&&(this.style.display=l),t&&"left"!==t||"none"===l||(this.style.left=i+"px"),t&&"top"!==t||"none"===l||(this.style.top=r+"px")})}),this.prev_interval_number=i,this.cell_div.node().display="block"},e.prototype.setLegendVisible=function(e,t){var n=this;e="undefined"==typeof e?this.oncoprint.getTracks():[].concat(e),_.each(e,function(e){n.getRuleSet(e).exclude_from_legend=!t}),this.renderLegend()},e.prototype.renderLegend=function(e){var t=this.oncoprint.getFullCellWidth(),a=this,o={};a.legend_table.selectAll("*").remove(),_.each(this.rule_sets,function(r,i){if(!r.exclude_from_legend||e){var s=r.getRuleSetId(),l={};if(_.each(a.active_rule_set_rules[s],function(e,t){$.extend(l,e)}),!o.hasOwnProperty(s)){var c=a.legend_table.append("tr"),d=c.append("td").style("padding-top","1em").style("padding-bottom","1em").append("span").classed("oncoprint-legend-header",!0);d.text(r.getLegendLabel());var u=c.append("td"),p=r.getLegendDiv(l,t,a.oncoprint.getCellHeight(i));u.node().appendChild(p),n.d3SelectChildren(d3.select(p),"*").classed("oncoprint-legend-block",!0),o[s]=!0}}})},e.prototype.dragLabel=function(e){this.getLabelDragDiv().style("display","block");var t=this.oncoprint.getContainingTrackGroup(e),a=t[0],o=t[t.length-1],r=this.getTrackLabelTops(),i={};_.each(t,function(e){i[e]=r[e]}),t.splice(t.indexOf(e),1);var l=_.map(t,function(e){return i[e]}),c=this.getLabelAreaHeight(),d=[void 0,void 0];d[0]=n.clamp(i[a],0,c),d[1]=n.clamp(i[o]+this.getRenderedTrackHeight(o),0,c);var u=this,p=$(u.getLabelDragDiv().node());delete i[e],function(e){var a=-1,o=function(o){o.stopPropagation&&o.stopPropagation(),o.preventDefault&&o.preventDefault();var r=n.clamp(n.mouseY(o),d[0],d[1]);u.renderTrackLabels(e,r),d3.selectAll(u.getTrackLabelCSSSelector(e)).classed(s,!0),a=_.sortedIndex(l,r),_.each(i,function(e,n){e+=3*+(a<t.length&&t[a]==n),e-=3*+(a>0&&t[a-1]==n),u.renderTrackLabels(n,e)})};p.on("mousemove",o);var r=function(t){p.hide(),p.off("mousemove",o),a>-1&&u.oncoprint.moveTrack(e,a)};$(document).one("mouseup",r)}(e)},e.prototype.toSVG=function(e){var t=this,a=$(this.container.node()).offset(),o=d3.select(document.createElementNS("http://www.w3.org/2000/svg","svg"));return o.attr("width",this.getLabelAreaWidth()+this.getCellAreaWidth()+"px"),this.renderLegend(!0),this.renderTrackLabels(void 0,void 0,e),o.attr("height",$(this.container.node()).height()+"px"),function(){t.label_div.selectAll(".oncoprint-track-label").each(function(){var e=d3.select(this),t=e.style("font-family")||"Arial",r=e.style("font-weight"),i=e.style("font-size")||"12px",s=$(e.node()).offset(),l=e.text();o.append("text").style("font-family",t).style("font-weight",r).style("font-size",i).attr("transform",n.translate(s.left-a.left,s.top-a.top)).style("alignment-baseline","hanging").text(l)})}(),function(){t.clipAndPositionCells(void 0,void 0,!0,!0),t.cell_div.selectAll(".oncoprint-cell").each(function(){var e=d3.select(this),t=e.node().getBoundingClientRect(),r={width:t.width,height:t.height},i=$(e.node()).offset(),s=o.append("g").attr("transform",n.translate(i.left-a.left,i.top-a.top));e.selectAll("*").each(function(){n.appendD3SVGElement(d3.select(this),s)});var l={color:e.style("outline-color"),width:e.style("outline-width")};l.color&&s.append("rect").attr("width",r.width+"px").attr("height",r.height+"px").style("fill","none").style("stroke",l.color).style("stroke-width",l.width);
}),t.clipAndPositionCells(void 0,void 0,!0)}(),function(){t.legend_table.selectAll("tr").each(function(){d3.select(this).selectAll("td").each(function(){d3.select(this).selectAll(".oncoprint-legend-header,.oncoprint-legend-element").each(function(){if($(this).text().trim().length){var e=d3.select(this),t=e.style("font-family")||"Arial";"Arial"!==t&&console.log(this);var r=e.style("font-weight"),i=e.style("font-size")||"12px",s=e.text(),l=$(e.node()).offset();o.append("text").style("font-family",t).style("font-weight",r).style("font-size",i).attr("transform",n.translate(l.left-a.left,l.top-a.top)).style("alignment-baseline","hanging").text(s)}else if("svg"===this.tagName.toLowerCase()){var c=d3.select(this),l=$(c.node()).offset(),d=o.append("g").attr("transform",n.translate(l.left-a.left,l.top-a.top)),u=c.node().getBoundingClientRect(),p={width:u.width,height:u.height},g={color:c.style("outline-color"),width:c.style("outline-width")};g.color&&d.append("rect").attr("width",p.width+"px").attr("height",p.height+"px").style("fill","none").style("stroke",g.color).style("stroke-width",g.width),c.selectAll("*").each(function(){n.appendD3SVGElement(d3.select(this),d)})}})})})}(),this.renderLegend(),this.renderTrackLabels(),o.node()},e}(),window.Oncoprint=function(){function e(e){var a=this,o=n.makeIdCounter();a.config=e,a.id_order=[],a.inverted_id_order={},a.visible_id_order=[],a.visible_inverted_id_order={},a.hidden_ids={},a.track_groups=[[],[]],a.track_group_sort_order=[0,1],a.sort_direction={},a.tracks={},a.sort_config={type:"track"},a.cell_padding_on=!0,a.true_cell_width=e.cell_width,a.zoomed_cell_width=a.true_cell_width,a.zoom=1,a.toggleCellPadding=function(){a.cell_padding_on=!a.cell_padding_on,$(a).trigger(t.SET_CELL_PADDING)},a.getCellPadding=function(){return Math.ceil(a.config.cell_padding*a.getZoom())*+a.cell_padding_on},a.getZoom=function(){return a.zoom},a.setZoom=function(e){return a.zoom=n.clamp(e,0,1),s(),r(),$(a).trigger(t.SET_ZOOM),a.zoom};var r=function(){a.zoom=(a.zoomed_cell_width-1)/(a.true_cell_width-1)},s=function(){a.zoomed_cell_width=Math.round(a.zoom*(a.true_cell_width-1)+1)};a.increaseZoom=function(){return a.zoomed_cell_width=n.clamp(a.zoomed_cell_width+1,1,a.true_cell_width),r(),$(a).trigger(t.SET_ZOOM),a.zoom},a.decreaseZoom=function(){return a.zoomed_cell_width=n.clamp(a.zoomed_cell_width-1,1,a.true_cell_width),r(),$(a).trigger(t.SET_ZOOM),a.zoom},a.getFullCellWidth=function(){return a.true_cell_width},a.getZoomedCellWidth=function(){return a.zoomed_cell_width},a.getCellHeight=function(e){return a.tracks[e].config.cell_height},a.getTrackHeight=function(e){return a.tracks[e].config.track_height},a.getTrackPadding=function(e){return a.tracks[e].config.track_padding},a.getFilteredIdOrder=function(e,t){var n=t||a.getTracks();return _.filter(a.id_order,function(t){var o=_.map(n,function(e){return a.getTrackDatum(e,t)});return e(o)})},a.getIdOrder=function(){return a.id_order},a.getInvertedIdOrder=function(){return a.inverted_id_order},a.getVisibleIdOrder=function(){return a.visible_id_order},a.getVisibleInvertedIdOrder=function(){return a.visible_inverted_id_order};var l=function(){a.visible_id_order=_.filter(a.id_order,function(e){return!a.hidden_ids[e]}),a.visible_inverted_id_order=n.invert_array(a.visible_id_order),$(a).trigger(t.SET_VISIBLE_ID_ORDER)};a.setIdOrder=function(e){a.id_order=e.slice(),a.inverted_id_order=n.invert_array(a.id_order),l(),$(a).trigger(t.SET_ID_ORDER)},a.hideIds=function(e,t){t&&(a.hidden_ids={}),_.each(e,function(e){a.hidden_ids[e]=!0}),l()},a.showIds=function(e){e?_.each(e,function(e){delete a.hidden_ids[e]}):a.hidden_ids={},l()},a.getTopmostTrack=function(){return a.track_groups[0].length>0?a.track_groups[0][0]:a.track_groups[1][0]},a.setTrackSortComparator=function(e,t){a.tracks[e].config.sort_cmp=t},a.getTrackSortComparator=function(e){return a.tracks[e].config.sort_cmp},a.getTrackSortDirection=function(e){return a.sort_direction[e]},a.setTrackSortDirection=function(e,t){a.sort_direction[e]=t,a.sort()},a.setTrackGroupSortOrder=function(e){a.track_group_sort_order=e.slice()},a.getTrackGroupSortOrder=function(){return a.track_group_sort_order.slice()},a.getTrackSortOrder=function(){var e=[],t=a.getTrackGroups();return _.each(a.getTrackGroupSortOrder(),function(n){e=e.concat(t[n])}),e},a.setSortConfig=function(e){a.sort_config=e};var c=function(e){var t=_.sortBy(a.getIdOrder(),_.identity);e&&t.reverse(),a.setIdOrder(t)},d=function(){var e=a.getTrackSortOrder(),t=_.map(e,function(e){return a.getTrackSortComparator(e)}),o={},r=a.getIdOrder();_.each(r,function(t){o[t]={},_.each(e,function(e){o[t][e]=a.getTrackDatum(e,t)})});var i=function(n,r){for(var i=0,s=0,l=e.length;l>s;s++){var c=e[s],d=t[s],u=o[n][c],p=o[r][c],g="undefined"==typeof u,h="undefined"==typeof p;if(i=g||h?g&&h?0:g?1:-1:d(u,p),isFinite(i)&&(i*=a.sort_direction[c]),0!==i)break}return i};a.setIdOrder(n.stableSort(a.getIdOrder(),i))};a.sort=function(){var e=a.sort_config;"track"===e.type?d():"id"===e.type&&c(e.desc)},a.addTrack=function(e,r){r=n.ifndef(r,1);var s=o();return a.tracks[s]={id:s,data:[],config:$.extend({},i,e),id_data_map:{}},a.track_groups[r].push(s),a.sort_direction[s]=1,$(a).trigger(t.ADD_TRACK,{track_id:s}),s},a.removeTrack=function(e){var n=a.tracks[e];delete a.tracks[e],delete a.sort_direction[e];var o=a.getContainingTrackGroup(e,!0);if(o){var r=o.indexOf(e);return o.splice(r,1),$(a).trigger(t.REMOVE_TRACK,{track:n,track_id:e}),!0}return!1},a.getTrackGroups=function(e){return e===!0?a.track_groups:$.extend(!0,[],a.track_groups)},a.getTracks=function(){return _.flatten(a.getTrackGroups())},a.getContainingTrackGroup=function(e,t){var n=!1;return _.find(a.track_groups,function(t){return t.indexOf(e)>-1?(n=t,!0):!1}),t===!0?n:n.slice()},a.moveTrack=function(e,o){var r=a.getContainingTrackGroup(e,!0);if(!r)return!1;var i=r.indexOf(e);o=n.clamp(o,0,r.length-1),r.splice(i,1),r.splice(o,0,e);var s=r.slice(Math.min(i,o),Math.max(i,o)+1);$(a).trigger(t.MOVE_TRACK,{moved_tracks:s})},a.getTrackLabel=function(e){return a.tracks[e].config.label},a.getTrackTooltip=function(e){return a.tracks[e].config.tooltip},a.setTrackTooltip=function(e,t){a.tracks[e].config.tooltip=t},a.getTrackData=function(e){return a.tracks[e].data},a.setTrackData=function(e,n){var o=a.getTrackDatumIdAccessor(e);a.tracks[e].data=n;var r=a.getIdOrder(),i=a.getInvertedIdOrder();_.each(_.map(n,o),function(e){e in i||r.push(e)}),a.setIdOrder(r),a.tracks[e].id_data_map={};var s=a.tracks[e].id_data_map;_.each(a.tracks[e].data,function(e){s[o(e)]=e}),$(a).trigger(t.SET_TRACK_DATA,{track_id:e})},a.getTrackDatum=function(e,t){return a.tracks[e].id_data_map[t]},a.getTrackDatumDataKey=function(e){return a.tracks[e].config.datum_data_key},a.getTrackDatumIdAccessor=function(e){var t=a.getTrackDatumIdKey(e);return function(e){return e[t]}},a.getTrackDatumIdKey=function(e){return a.tracks[e].config.datum_id_key},a.setTrackDatumIdKey=function(e,t){a.tracks[e].config.datum_id_key=t},a.isTrackRemovable=function(e){return a.tracks[e].config.removable},a.isTrackSortDirectionChangable=function(e){return a.tracks[e].config.sort_direction_changable},a.clearData=function(){_.each(a.getTracks(),function(e){a.setTrackData(e,[])}),a.setIdOrder([])}}var t=oncoprint_events,n=oncoprint_utils,a=oncoprint_RuleSet,o={cell_width:6,cell_padding:2.5,legend:!0},r={pre_track_padding:0},i={label:"Gene",datum_id_key:"patient",cell_height:23,track_height:20,track_padding:5,sort_cmp:void 0,tooltip:function(e){return e.patient},removable:!1,sort_direction_changable:!1};return{CATEGORICAL_COLOR:a.CATEGORICAL_COLOR,GRADIENT_COLOR:a.GRADIENT_COLOR,GENETIC_ALTERATION:a.GENETIC_ALTERATION,BAR_CHART:a.BAR_CHART,create:function(n,a){a=$.extend({},o,a||{}),a=$.extend(a,r);var i=new e(a),s=new OncoprintSVGRenderer(n,i,{label_font:"Arial",legend:a.legend}),l={onc_dev:i,ren_dev:s,addTrack:function(e,t){var n=i.addTrack(e,t);return n},removeTrack:function(e){i.removeTrack(e)},moveTrack:function(e,t){i.moveTrack(e,t)},setTrackDatumIdKey:function(e,t){i.setTrackDatumIdKey(e,t)},setTrackData:function(e,t){i.setTrackData(e,t)},setRuleSet:function(e,t,n){s.setRuleSet(e,t,n)},useSameRuleSet:function(e,t){s.useSameRuleSet(e,t)},toggleCellPadding:function(){i.toggleCellPadding()},toSVG:function(){return s.toSVG()},setTrackGroupSortOrder:function(e){i.setTrackGroupSortOrder(e)},sort:function(){i.sort()},setSortConfig:function(e){i.setSortConfig(e)},setIdOrder:function(e){i.setIdOrder(e)},getTrackSortDirection:function(e){return i.getTrackSortDirection(e)},setTrackSortDirection:function(e,t){i.setTrackSortDirection(e,t)},setZoom:function(e){return i.setZoom(e)},increaseZoom:function(){return i.increaseZoom()},decreaseZoom:function(){return i.decreaseZoom()},suppressRendering:function(){s.suppressRendering()},releaseRendering:function(){s.releaseRendering()},setLegendVisible:function(e,t){s.setLegendVisible(e,t)},getFilteredIdOrder:function(e,t){return i.getFilteredIdOrder(e,t)},getVisibleIdOrder:function(){return i.getVisibleIdOrder()},hideIds:function(e){i.hideIds(e)},showIds:function(e){i.showIds(e)},clearData:function(){i.clearData()},setTrackTooltip:function(e,t){i.setTrackTooltip(e,t)}};return $(i).on(t.MOVE_TRACK,function(){$(l).trigger(t.MOVE_TRACK)}),$(s).on(t.FINISHED_RENDERING,function(){$(l).trigger(t.FINISHED_RENDERING)}),$(i).on(t.REMOVE_TRACK,function(e,n){$(l).trigger(t.REMOVE_TRACK,{track_id:n.track_id})}),$(s).on(t.CONTENT_AREA_MOUSEENTER,function(e,n){$(l).trigger(t.CONTENT_AREA_MOUSEENTER)}),$(s).on(t.CONTENT_AREA_MOUSELEAVE,function(e,n){$(l).trigger(t.CONTENT_AREA_MOUSELEAVE)}),l}}}();var LinkoutModule=function(){function e(e){console.log(JSON.stringify(e));var t=e.payload.value,n=t[0],a='http://www.google.com/search?q="'+n+'"';window.open(a)}function t(e){console.log(JSON.stringify(e));for(var t=e.payload.value,n=t[0],a=1;a<e.payload.value.length;a++)n=n+","+t[a];var o="http://dgidb.genome.wustl.edu/interaction_search_results?genes="+n;o+="&limit_drugs=true",window.open(o)}function n(e){console.log(JSON.stringify(e));var t="https://en.wikipedia.org/wiki/",n=e.payload.value,a=n[0],o=t+a;window.open(o)}function a(e){console.log(JSON.stringify(e));var t="http://www.genecards.org/cgi-bin/carddisp.pl?gene=",n=e.payload.value,a=n[0],o=t+a;window.open(o)}function o(){hub.registerSelectionDestination(r,i),hub.addMessageHandler("sendSelectionTo_DGIdb",t),hub.addMessageHandler("sendSelectionTo_Wikipedia",n),hub.addMessageHandler("sendSelectionTo_Google",e),hub.addMessageHandler("sendSelectionTo_GeneCards",a)}var r=["DGIdb","Wikipedia","Google","GeneCards"],i=null;return{init:o}};linkoutModule=LinkoutModule(),linkoutModule.init();